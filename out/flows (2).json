[
    {
        "id": "e8596285.3adc3",
        "type": "tab",
        "label": "Flow 1",
        "disabled": true,
        "info": ""
    },
    {
        "id": "b49784d.ed72f78",
        "type": "tab",
        "label": "send/receive mqtt data",
        "disabled": true,
        "info": ""
    },
    {
        "id": "cf28689a.8db668",
        "type": "tab",
        "label": "on/off loop",
        "disabled": true,
        "info": ""
    },
    {
        "id": "83e79aae.1151c8",
        "type": "tab",
        "label": "api  call",
        "disabled": true,
        "info": ""
    },
    {
        "id": "8bcef02c.883e4",
        "type": "tab",
        "label": "Flow 2",
        "disabled": true,
        "info": ""
    },
    {
        "id": "e3fb0bc9.4cb118",
        "type": "tab",
        "label": "Flow 3",
        "disabled": true,
        "info": ""
    },
    {
        "id": "ca426e9f.74914",
        "type": "tab",
        "label": "broker_auth",
        "disabled": false,
        "info": "Flow pour l'authentification des bracelets"
    },
    {
        "id": "ae64b298.b7071",
        "type": "tab",
        "label": "broker_getRecords",
        "disabled": false,
        "info": ""
    },
    {
        "id": "b94f6bbb.19bb98",
        "type": "tab",
        "label": "broker_zone",
        "disabled": false,
        "info": ""
    },
    {
        "id": "f13b69cc.303b38",
        "type": "tab",
        "label": "brokers",
        "disabled": false,
        "info": ""
    },
    {
        "id": "9137a9b2.f5e7d8",
        "type": "tab",
        "label": "broker_fileD’attente",
        "disabled": false,
        "info": ""
    },
    {
        "id": "2237ecd8.c072a4",
        "type": "group",
        "z": "ae64b298.b7071",
        "name": "verify mac adress",
        "style": {
            "label": true
        },
        "nodes": [
            "6c707639.77da48",
            "e9472095.984ca",
            "5e9f5fb7.f1f81",
            "2398fb29.5e26e4",
            "7fb4d405.e6e74c",
            "ff134346.7f718"
        ],
        "x": 794,
        "y": 179
    },
    {
        "id": "527c0c5.94a06f4",
        "type": "group",
        "z": "ae64b298.b7071",
        "name": "error managment",
        "style": {
            "label": true
        },
        "nodes": [
            "fc4438f9.cb9b68",
            "21abda46.d794f6",
            "f63e6857.ad89b8",
            "3a21e9dc.2e3e86",
            "3443edf1.83d102",
            "8305411b.4b7ed",
            "13814d4a.7bf2f3",
            "e80e10f1.2c9bb",
            "157f1dde.cafc12"
        ],
        "x": 2694,
        "y": 199
    },
    {
        "id": "ab4905c.3eaaef8",
        "type": "group",
        "z": "ca426e9f.74914",
        "name": "error managment",
        "style": {
            "label": true
        },
        "nodes": [
            "7ed6431e.76591c",
            "ed24bb0e.8b8ef8",
            "cf041cba.1e56b",
            "7adee4b2.81c55c",
            "5b18bfde.29218",
            "a27c3507.d280f8",
            "57cac35e.049f6c",
            "d8737a5b.b37a18",
            "33b12978.ddfdf6"
        ],
        "x": 1994,
        "y": 179
    },
    {
        "id": "d5fedbb5.051ae8",
        "type": "group",
        "z": "b94f6bbb.19bb98",
        "name": "error managment",
        "style": {
            "label": true
        },
        "nodes": [
            "334251a2.40d31e",
            "dafd61e6.39313",
            "966a1f00.144a8",
            "648f4a50.cb96f4",
            "8b323cf4.22f02",
            "7d36d325.9a6e1c",
            "70e23f0e.5c754",
            "9efaa326.bd995",
            "48519d4d.4a9af4"
        ],
        "x": 1574,
        "y": 299
    },
    {
        "id": "34b503d8.c99a4c",
        "type": "group",
        "z": "f13b69cc.303b38",
        "name": "error managment",
        "style": {
            "label": true
        },
        "nodes": [
            "4c2c8fe.5836a7",
            "f1a83587.dc3c88",
            "4c3b3373.572dcc",
            "171ff356.0236fd",
            "4af4e024.55264",
            "d0f4e31a.6ec83",
            "91d54218.1842f",
            "d00b5522.859dd8",
            "78f77e72.d99bb"
        ],
        "x": 2554,
        "y": 259
    },
    {
        "id": "6652510e.cda13",
        "type": "group",
        "z": "9137a9b2.f5e7d8",
        "name": "Test if thebracelet already have an ongoing ticket",
        "style": {
            "label": true
        },
        "nodes": [
            "18e46e0b.ef9552",
            "b94f667d.536148",
            "634ef386.68071c",
            "270f6dfa.f61ac2"
        ],
        "x": 774,
        "y": 139,
        "w": 672,
        "h": 82
    },
    {
        "id": "d19f0307.1f526",
        "type": "group",
        "z": "9137a9b2.f5e7d8",
        "name": "create a ticket for the bracelet",
        "style": {
            "label": true
        },
        "nodes": [
            "9f2d13cd.35133",
            "8dc420a5.e374f",
            "bc720d1c.fc48e",
            "71b266e.530b198"
        ],
        "x": 1454,
        "y": 99,
        "w": 692,
        "h": 82
    },
    {
        "id": "96ca1e42.77651",
        "type": "group",
        "z": "9137a9b2.f5e7d8",
        "name": "queue line",
        "style": {
            "label": true
        },
        "nodes": [
            "4e51ec98.0e78f4",
            "9f98cfa6.bbb74",
            "24a963eb.9ba6cc",
            "cbd02ae1.f7e648"
        ],
        "x": 2154,
        "y": 99,
        "w": 692,
        "h": 82
    },
    {
        "id": "2a66e0db.3d554",
        "type": "group",
        "z": "9137a9b2.f5e7d8",
        "name": "Set globals",
        "style": {
            "label": true
        },
        "nodes": [
            "45c73ee9.63b5a",
            "7eb1aa6c.ce50a4",
            "a1808b36.4a8398"
        ],
        "x": 74,
        "y": 19,
        "w": 672,
        "h": 82
    },
    {
        "id": "839e847e.e0aae8",
        "type": "group",
        "z": "9137a9b2.f5e7d8",
        "name": "send response back",
        "style": {
            "label": true
        },
        "nodes": [
            "3cc3a9a8.386a96",
            "aba526e9.7d2ad8",
            "d1e2b7f2.fb5218"
        ],
        "x": 2854,
        "y": 99,
        "w": 492,
        "h": 82
    },
    {
        "id": "98550463.c21328",
        "type": "group",
        "z": "9137a9b2.f5e7d8",
        "name": "error managment",
        "style": {
            "label": true
        },
        "nodes": [
            "9635978a.55f6d8",
            "6bbad059.6fed",
            "d84a82b4.23df4",
            "6b2a8840.578b88",
            "8ccfc47f.d25ee8",
            "665a6f04.1846b",
            "3e89fd3.f69b502",
            "2884029b.44fd1e",
            "511474f5.a0e38c"
        ],
        "x": 3774,
        "y": 119,
        "w": 1052,
        "h": 182
    },
    {
        "id": "3f880a49.478716",
        "type": "group",
        "z": "ca426e9f.74914",
        "name": "if auth gen welcome msg => {msg : '', points : ''}",
        "style": {
            "label": true,
            "label-position": "sw"
        },
        "nodes": [
            "575c52ac.e736bc",
            "4e51a684.18e388",
            "791e5401.a31f0c",
            "90b6e771.e8f048"
        ],
        "x": 1254,
        "y": 299
    },
    {
        "id": "72cb9daa.bab524",
        "type": "group",
        "z": "ca426e9f.74914",
        "name": "format data",
        "style": {
            "label": true
        },
        "nodes": [
            "cdc23649.082158",
            "de51f706.6bbf68",
            "9971e316.2ae56",
            "5bde32ae.7b4f0c"
        ],
        "x": 474,
        "y": 699
    },
    {
        "id": "3b7292ed.26d4ce",
        "type": "group",
        "z": "ca426e9f.74914",
        "name": "get broker/personnel ID",
        "style": {
            "label": true
        },
        "nodes": [
            "f2758db8.b21ac",
            "1ce40efa.1e66a1",
            "7534db37.d52994"
        ],
        "x": 1294,
        "y": 679
    },
    {
        "id": "c4263f1b.7a02d",
        "type": "group",
        "z": "ca426e9f.74914",
        "name": "queries setup",
        "style": {
            "label": true
        },
        "nodes": [
            "bc2bc4bf.580848",
            "920c161c.5e5be8",
            "1f0d3eee.9cb261",
            "2de50935.6ed236"
        ],
        "x": 1834,
        "y": 639
    },
    {
        "id": "212eb9bd.d3a8e6",
        "type": "group",
        "z": "ca426e9f.74914",
        "name": "get user points log",
        "style": {
            "label": true
        },
        "nodes": [
            "4a7def2e.2f48a",
            "2e80569e.b3828a",
            "4eb35255.4effcc"
        ],
        "x": 2694,
        "y": 759
    },
    {
        "id": "bbaad6bd.889a48",
        "type": "group",
        "z": "ca426e9f.74914",
        "name": "get ranking query",
        "style": {
            "label": true
        },
        "nodes": [
            "1f34a8e8.41cfe7",
            "18d786af.f2efb9",
            "bce55376.50184"
        ],
        "x": 3554,
        "y": 779
    },
    {
        "id": "cdac6aae.82e518",
        "type": "group",
        "z": "ca426e9f.74914",
        "name": "feedback to bracelet",
        "style": {
            "label": true
        },
        "nodes": [
            "f6cdeae0.89d008",
            "2a0c88ea.cabc58",
            "4110e587.2968cc"
        ],
        "x": 4274,
        "y": 819
    },
    {
        "id": "2428ed.453b6714",
        "type": "group",
        "z": "ae64b298.b7071",
        "style": {
            "stroke": "#999999",
            "stroke-opacity": "1",
            "fill": "none",
            "fill-opacity": "1",
            "label": true,
            "label-position": "nw",
            "color": "#a4a4a4"
        },
        "nodes": [
            "ddaa329.cdb85d",
            "f1c28713.ed06f8",
            "40a4657a.37da7c"
        ],
        "x": 1654,
        "y": 119
    },
    {
        "id": "7cfe8395.77f95c",
        "type": "group",
        "z": "9137a9b2.f5e7d8",
        "name": "ticket validation",
        "style": {
            "label": true
        },
        "nodes": [
            "46ef3f67.b132a",
            "7e01799a.f5cac8",
            "709f3ddd.b01134"
        ],
        "x": 1534,
        "y": 339,
        "w": 572,
        "h": 82
    },
    {
        "id": "b12f86f0.a40768",
        "type": "group",
        "z": "9137a9b2.f5e7d8",
        "name": "post validation if 'bracelet' was not detected in the other broker",
        "style": {
            "label": true,
            "label-position": "sw"
        },
        "nodes": [
            "789623ce.03a49c",
            "7223d3e7.58edfc",
            "fe7ec1e9.97ea4"
        ],
        "x": 1534,
        "y": 499,
        "w": 572,
        "h": 90,
        "info": "we check because if a 'bracelet' was not detected in 2 brokers in 5 sec it means it has left, but in case of first time going in it'll cause a bug, cause for the first time the device isn't linked to 2 brokers."
    },
    {
        "id": "6ca842f1.31428c",
        "type": "mqtt-broker",
        "z": "",
        "name": "Local",
        "broker": "127.0.0.1",
        "port": "1883",
        "clientid": "",
        "usetls": false,
        "compatmode": false,
        "keepalive": "60",
        "cleansession": true,
        "birthTopic": "",
        "birthQos": "0",
        "birthPayload": "",
        "closeTopic": "",
        "closeQos": "0",
        "closePayload": "",
        "willTopic": "",
        "willQos": "0",
        "willPayload": ""
    },
    {
        "id": "71579c9b.0ca394",
        "type": "ui_tab",
        "z": "",
        "name": "Home",
        "icon": "dashboard",
        "disabled": false,
        "hidden": false
    },
    {
        "id": "674fae8.56f1e5",
        "type": "ui_group",
        "z": "",
        "name": "Home",
        "tab": "71579c9b.0ca394",
        "order": 1,
        "disp": true,
        "width": "6",
        "collapse": false
    },
    {
        "id": "2c429998.444416",
        "type": "mqtt-broker",
        "z": "",
        "name": "mqtt_setup",
        "broker": "localhost",
        "port": "1883",
        "clientid": "",
        "usetls": false,
        "compatmode": false,
        "keepalive": "60",
        "cleansession": true,
        "birthTopic": "",
        "birthQos": "0",
        "birthPayload": "",
        "closeTopic": "",
        "closeQos": "0",
        "closePayload": "",
        "willTopic": "",
        "willQos": "0",
        "willPayload": ""
    },
    {
        "id": "c9a66da.209299",
        "type": "mqtt-broker",
        "z": "",
        "name": "",
        "broker": "localhost",
        "port": "1883",
        "clientid": "",
        "usetls": false,
        "compatmode": false,
        "keepalive": "60",
        "cleansession": true,
        "birthTopic": "",
        "birthQos": "0",
        "birthPayload": "",
        "closeTopic": "",
        "closeQos": "0",
        "closePayload": "",
        "willTopic": "",
        "willQos": "0",
        "willPayload": ""
    },
    {
        "id": "455cfbb2.9d9714",
        "type": "MySQLdatabase",
        "z": "",
        "name": "db-config",
        "host": "127.0.0.1",
        "port": "3306",
        "db": "projet001",
        "tz": "",
        "charset": ""
    },
    {
        "id": "303a6a67.c3cd16",
        "type": "inject",
        "z": "e8596285.3adc3",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 230,
        "y": 380,
        "wires": [
            [
                "c5a604d5.d16948",
                "1c52077d.700069"
            ]
        ]
    },
    {
        "id": "c5a604d5.d16948",
        "type": "function",
        "z": "e8596285.3adc3",
        "name": "",
        "func": "// Create a Date object from the payload\nvar date = new Date(msg.payload);\n// Change the payload to be a formatted Date string\nmsg.payload = date.toString();\n// Return the message so it can be sent on\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 350,
        "y": 460,
        "wires": [
            [
                "b17ca476.afe468"
            ]
        ]
    },
    {
        "id": "b17ca476.afe468",
        "type": "debug",
        "z": "e8596285.3adc3",
        "name": "log_1",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 470,
        "y": 380,
        "wires": []
    },
    {
        "id": "1c52077d.700069",
        "type": "debug",
        "z": "e8596285.3adc3",
        "name": "log_2",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 470,
        "y": 320,
        "wires": []
    },
    {
        "id": "9bbe3dc3.84755",
        "type": "inject",
        "z": "b49784d.ed72f78",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 270,
        "y": 280,
        "wires": [
            [
                "a9bb935.cece07"
            ]
        ]
    },
    {
        "id": "a9bb935.cece07",
        "type": "mqtt out",
        "z": "b49784d.ed72f78",
        "name": "test",
        "topic": "hmm/test",
        "qos": "",
        "retain": "",
        "broker": "6ca842f1.31428c",
        "x": 490,
        "y": 280,
        "wires": []
    },
    {
        "id": "5eb3e210.b0eefc",
        "type": "mqtt in",
        "z": "b49784d.ed72f78",
        "name": "",
        "topic": "hmm/test",
        "qos": "2",
        "datatype": "auto",
        "broker": "6ca842f1.31428c",
        "x": 260,
        "y": 360,
        "wires": [
            [
                "88c68796.e652a8"
            ]
        ]
    },
    {
        "id": "88c68796.e652a8",
        "type": "debug",
        "z": "b49784d.ed72f78",
        "name": "mqtt output",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 470,
        "y": 360,
        "wires": []
    },
    {
        "id": "a1098433.659e38",
        "type": "delay",
        "z": "cf28689a.8db668",
        "name": "",
        "pauseType": "delay",
        "timeout": "1",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 540,
        "y": 220,
        "wires": [
            [
                "dce605bc.3ce2c8"
            ]
        ]
    },
    {
        "id": "9bdac6eb.e32d88",
        "type": "inject",
        "z": "cf28689a.8db668",
        "name": "start loop",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            },
            {
                "p": "data",
                "v": "",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "1",
        "payloadType": "num",
        "x": 340,
        "y": 300,
        "wires": [
            [
                "11ffdf64.bee001"
            ]
        ]
    },
    {
        "id": "dce605bc.3ce2c8",
        "type": "function",
        "z": "cf28689a.8db668",
        "name": "",
        "func": "if(global.get(\"publicVariables\").loopExecution == 1){\n    msg.data = Math.random().toString();\n    return msg;\n}",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 720,
        "y": 220,
        "wires": [
            [
                "9052455d.071a58",
                "df10e74e.698c38"
            ]
        ]
    },
    {
        "id": "9052455d.071a58",
        "type": "debug",
        "z": "cf28689a.8db668",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "data",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 950,
        "y": 240,
        "wires": []
    },
    {
        "id": "df10e74e.698c38",
        "type": "switch",
        "z": "cf28689a.8db668",
        "name": "",
        "property": "publicVariables.loopExecution",
        "propertyType": "global",
        "rules": [
            {
                "t": "eq",
                "v": "0",
                "vt": "num"
            },
            {
                "t": "eq",
                "v": "1",
                "vt": "num"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 530,
        "y": 320,
        "wires": [
            [
                "52d455b.1a302ac"
            ],
            [
                "a1098433.659e38"
            ]
        ]
    },
    {
        "id": "52d455b.1a302ac",
        "type": "function",
        "z": "cf28689a.8db668",
        "name": "",
        "func": "msg.data = \"Loop stopped\";\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 740,
        "y": 320,
        "wires": [
            [
                "9052455d.071a58"
            ]
        ]
    },
    {
        "id": "df1a13c5.cbb85",
        "type": "inject",
        "z": "cf28689a.8db668",
        "name": "stop loop",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "0",
        "payloadType": "num",
        "x": 340,
        "y": 460,
        "wires": [
            [
                "11ffdf64.bee001"
            ]
        ]
    },
    {
        "id": "11ffdf64.bee001",
        "type": "function",
        "z": "cf28689a.8db668",
        "name": "",
        "func": "var publicVariables = {\n    loopExecution: msg.payload\n}\nglobal.set(\"publicVariables\", publicVariables);\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 420,
        "y": 380,
        "wires": [
            [
                "df10e74e.698c38"
            ]
        ]
    },
    {
        "id": "51d4e13e.aa113",
        "type": "delay",
        "z": "cf28689a.8db668",
        "name": "",
        "pauseType": "delay",
        "timeout": "1",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 540,
        "y": 600,
        "wires": [
            [
                "f7a80cf4.d4242"
            ]
        ]
    },
    {
        "id": "dc194d02.c0f4d",
        "type": "inject",
        "z": "cf28689a.8db668",
        "name": "start loop",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            },
            {
                "p": "data",
                "v": "",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "1",
        "payloadType": "num",
        "x": 340,
        "y": 680,
        "wires": [
            [
                "338ea63d.7a5fba"
            ]
        ]
    },
    {
        "id": "f7a80cf4.d4242",
        "type": "function",
        "z": "cf28689a.8db668",
        "name": "",
        "func": "if(global.get(\"publicVariables\").loopExecution == 1){\n    msg.payload = {status:\"on\",data:Math.random().toString()};\n    return msg;\n}",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 720,
        "y": 600,
        "wires": [
            [
                "3c959187.4b101e",
                "2cf4b5f8.86e82a"
            ]
        ]
    },
    {
        "id": "3c959187.4b101e",
        "type": "switch",
        "z": "cf28689a.8db668",
        "name": "",
        "property": "publicVariables.loopExecution",
        "propertyType": "global",
        "rules": [
            {
                "t": "eq",
                "v": "0",
                "vt": "num"
            },
            {
                "t": "eq",
                "v": "1",
                "vt": "num"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 530,
        "y": 700,
        "wires": [
            [
                "c97bd1fb.5758b"
            ],
            [
                "51d4e13e.aa113"
            ]
        ]
    },
    {
        "id": "c97bd1fb.5758b",
        "type": "function",
        "z": "cf28689a.8db668",
        "name": "",
        "func": "msg.payload = {status:\"off\",data:\"Loop stopped\"};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 740,
        "y": 700,
        "wires": [
            [
                "2cf4b5f8.86e82a"
            ]
        ]
    },
    {
        "id": "e4a39622.b6b598",
        "type": "inject",
        "z": "cf28689a.8db668",
        "name": "stop loop",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "0",
        "payloadType": "num",
        "x": 340,
        "y": 840,
        "wires": [
            [
                "338ea63d.7a5fba"
            ]
        ]
    },
    {
        "id": "338ea63d.7a5fba",
        "type": "function",
        "z": "cf28689a.8db668",
        "name": "",
        "func": "var publicVariables = {\n    loopExecution: msg.payload\n}\nglobal.set(\"publicVariables\", publicVariables);\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 420,
        "y": 760,
        "wires": [
            [
                "3c959187.4b101e"
            ]
        ]
    },
    {
        "id": "2cf4b5f8.86e82a",
        "type": "mqtt out",
        "z": "cf28689a.8db668",
        "name": "",
        "topic": "hmm/test2",
        "qos": "",
        "retain": "",
        "broker": "6ca842f1.31428c",
        "x": 990,
        "y": 660,
        "wires": []
    },
    {
        "id": "2cda07c9.221668",
        "type": "mqtt in",
        "z": "b49784d.ed72f78",
        "name": "",
        "topic": "hmm/test2",
        "qos": "2",
        "datatype": "auto",
        "broker": "6ca842f1.31428c",
        "x": 260,
        "y": 440,
        "wires": [
            [
                "ae234201.4beaa"
            ]
        ]
    },
    {
        "id": "12839346.4fba5d",
        "type": "debug",
        "z": "b49784d.ed72f78",
        "name": "mqtt output",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 610,
        "y": 440,
        "wires": []
    },
    {
        "id": "ae234201.4beaa",
        "type": "yaml",
        "z": "b49784d.ed72f78",
        "property": "payload",
        "name": "",
        "x": 430,
        "y": 440,
        "wires": [
            [
                "12839346.4fba5d"
            ]
        ]
    },
    {
        "id": "9b4bf8b2.ece718",
        "type": "inject",
        "z": "83e79aae.1151c8",
        "name": "Initiate",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "true",
        "payloadType": "bool",
        "x": 400,
        "y": 380,
        "wires": [
            [
                "108e3eb.e460ec1"
            ]
        ]
    },
    {
        "id": "108e3eb.e460ec1",
        "type": "http request",
        "z": "83e79aae.1151c8",
        "name": "fake rest api",
        "method": "GET",
        "ret": "txt",
        "paytoqs": "ignore",
        "url": "https://jsonplaceholder.typicode.com/posts",
        "tls": "",
        "persist": false,
        "proxy": "",
        "authType": "",
        "x": 670,
        "y": 380,
        "wires": [
            [
                "f69b576b.2b6158"
            ]
        ]
    },
    {
        "id": "f69b576b.2b6158",
        "type": "function",
        "z": "83e79aae.1151c8",
        "name": "",
        "func": "node.warn(JSON.parse(msg.payload));\nreturn null;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 960,
        "y": 380,
        "wires": [
            []
        ]
    },
    {
        "id": "8f2b2e57.1f519",
        "type": "http in",
        "z": "83e79aae.1151c8",
        "name": "index",
        "url": "/index",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 390,
        "y": 220,
        "wires": [
            [
                "5ec46790.c148d8"
            ]
        ]
    },
    {
        "id": "5ec46790.c148d8",
        "type": "template",
        "z": "83e79aae.1151c8",
        "name": "",
        "field": "payload",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "This is the payload: {{payload}} !",
        "output": "str",
        "x": 580,
        "y": 220,
        "wires": [
            [
                "8495f84f.704a38"
            ]
        ]
    },
    {
        "id": "8495f84f.704a38",
        "type": "http response",
        "z": "83e79aae.1151c8",
        "name": "index",
        "statusCode": "200",
        "headers": {},
        "x": 810,
        "y": 220,
        "wires": []
    },
    {
        "id": "2384c87.9919738",
        "type": "http in",
        "z": "83e79aae.1151c8",
        "name": "admin",
        "url": "admin api",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 370,
        "y": 540,
        "wires": [
            [
                "62434d8d.e81894"
            ]
        ]
    },
    {
        "id": "62434d8d.e81894",
        "type": "template",
        "z": "83e79aae.1151c8",
        "name": "",
        "field": "payload",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "This is the payload: {{payload}} !\n\n<script></script>",
        "output": "str",
        "x": 550,
        "y": 540,
        "wires": [
            [
                "e8f5ea84.888648"
            ]
        ]
    },
    {
        "id": "e8f5ea84.888648",
        "type": "http response",
        "z": "83e79aae.1151c8",
        "name": "",
        "statusCode": "200",
        "headers": {},
        "x": 740,
        "y": 540,
        "wires": []
    },
    {
        "id": "1a19ab39.b13485",
        "type": "http in",
        "z": "8bcef02c.883e4",
        "name": "Home_Page",
        "url": "/Home_Page",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 450,
        "y": 360,
        "wires": [
            [
                "2734796e.9fa0a6"
            ]
        ]
    },
    {
        "id": "2734796e.9fa0a6",
        "type": "template",
        "z": "8bcef02c.883e4",
        "name": "",
        "template": "<!DOCTYPE html> \n<html>\n<head>\n\t<title>Page Title</title>\n\t<meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n\t<link rel=\"stylesheet\" href=\"http://code.jquery.com/mobile/1.4.0/jquery.mobile-1.4.0.min.css\" />\n<script src=\"http://code.jquery.com/jquery-1.9.1.min.js\"></script>\n<script src=\"http://code.jquery.com/mobile/1.4.0/jquery.mobile-1.4.0.min.js\"></script>\n</head>\n\n<body>\n<!-- Start of first page: #one -->\n<div data-role=\"page\" id=\"one\">\n\n\t<div data-role=\"header\">\n\t\t<h1>Multi-page</h1>\n\t</div><!-- /header -->\n\n\t<div role=\"main\" class=\"ui-content\" >\n\t\t<h2>One</h2>\n\n\t\t<p>I have an <code>id</code> of \"one\" on my page container. I'm first in the source order so I'm shown when the page loads.</p>\n\n\t\t<p>This is a multi-page boilerplate template that you can copy to build your first jQuery Mobile page. This template contains multiple \"page\" containers inside, unlike a single page template that has just one page within it.</p>\n\t\t<p>Just view the source and copy the code to get started. All the CSS and JS is linked to the jQuery CDN versions so this is super easy to set up. Remember to include a meta viewport tag in the head to set the zoom level.</p>\n\t\t<p>You link to internal pages by referring to the <code>id</code> of the page you want to show. For example, to <a href=\"#two\" >link</a> to the page with an <code>id</code> of \"two\", my link would have a <code>href=\"#two\"</code> in the code.</p>\n\n\t\t<h3>Show internal pages:</h3>\n\t\t<p><a href=\"#two\" class=\"ui-btn ui-shadow ui-corner-all\">Show page \"two\"</a></p>\n\t\t<p><a href=\"#popup\" class=\"ui-btn ui-shadow ui-corner-all\" data-rel=\"dialog\" data-transition=\"pop\">Show page \"popup\" (as a dialog)</a></p>\n\t</div><!-- /content -->\n\n\t<div data-role=\"footer\" data-theme=\"a\">\n\t\t<h4>Page Footer</h4>\n\t</div><!-- /footer -->\n</div><!-- /page one -->\n\n<!-- Start of second page: #two -->\n<div data-role=\"page\" id=\"two\" data-theme=\"a\">\n\n\t<div data-role=\"header\">\n\t\t<h1>Two</h1>\n\t</div><!-- /header -->\n\n\t<div role=\"main\" class=\"ui-content\">\n\t\t<h2>Two</h2>\n\t\t<p>I have an id of \"two\" on my page container. I'm the second page container in this multi-page template.</p>\n\t\t<p>Notice that the theme is different for this page because we've added a few <code>data-theme</code> swatch assigments here to show off how flexible it is. You can add any content or widget to these pages, but we're keeping these simple.</p>\n\t\t<p><a href=\"#one\" data-direction=\"reverse\" class=\"ui-btn ui-shadow ui-corner-all ui-btn-b\">Back to page \"one\"</a></p>\n\n\t</div><!-- /content -->\n\n\t<div data-role=\"footer\">\n\t\t<h4>Page Footer</h4>\n\t</div><!-- /footer -->\n</div><!-- /page two -->\n\n<!-- Start of third page: #popup -->\n<div data-role=\"page\" id=\"popup\">\n\n\t<div data-role=\"header\" data-theme=\"b\">\n\t\t<h1>Dialog</h1>\n\t</div><!-- /header -->\n\n\t<div role=\"main\" class=\"ui-content\">\n\t\t<h2>Popup</h2>\n\t\t<p>I have an id of \"popup\" on my page container and only look like a dialog because the link to me had a <code>data-rel=\"dialog\"</code> attribute which gives me this inset look and a <code>data-transition=\"pop\"</code> attribute to change the transition to pop. Without this, I'd be styled as a normal page.</p>\n\t\t<p><a href=\"#one\" data-rel=\"back\" class=\"ui-btn ui-shadow ui-corner-all ui-btn-inline ui-icon-back ui-btn-icon-left\">Back to page \"one\"</a></p>\n\t</div><!-- /content -->\n\n\t<div data-role=\"footer\">\n\t\t<h4>Page Footer</h4>\n\t</div><!-- /footer -->\n</div><!-- /page popup -->\n</body>\n\n\n\n\n\n</html>",
        "x": 691,
        "y": 345,
        "wires": [
            [
                "4e30bce6.ecaf94"
            ]
        ]
    },
    {
        "id": "4e30bce6.ecaf94",
        "type": "http response",
        "z": "8bcef02c.883e4",
        "name": "",
        "x": 896,
        "y": 390,
        "wires": []
    },
    {
        "id": "33b686c8.2b180a",
        "type": "inject",
        "z": "e3fb0bc9.4cb118",
        "name": "",
        "repeat": "1",
        "once": true,
        "onceDelay": "1",
        "payloadType": "date",
        "x": 460,
        "y": 260,
        "wires": [
            [
                "e8b0dbe.7f46228"
            ]
        ]
    },
    {
        "id": "e8b0dbe.7f46228",
        "type": "debug",
        "z": "e3fb0bc9.4cb118",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 680,
        "y": 260,
        "wires": []
    },
    {
        "id": "9f45fd07.a96f3",
        "type": "mqtt in",
        "z": "b49784d.ed72f78",
        "name": "",
        "topic": "hmm/test3",
        "qos": "2",
        "datatype": "auto",
        "broker": "6ca842f1.31428c",
        "x": 260,
        "y": 540,
        "wires": [
            [
                "463cfa25.f07764",
                "ace5946d.25c408"
            ]
        ]
    },
    {
        "id": "463cfa25.f07764",
        "type": "ui_chart",
        "z": "b49784d.ed72f78",
        "name": "",
        "group": "674fae8.56f1e5",
        "order": 0,
        "width": 0,
        "height": 0,
        "label": "chart",
        "chartType": "line",
        "legend": "false",
        "xformat": "HH:mm",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": 1,
        "removeOlderPoints": "",
        "removeOlderUnit": "3600",
        "cutout": 0,
        "useOneColor": false,
        "useUTC": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "useOldStyle": false,
        "outputs": 1,
        "x": 440,
        "y": 540,
        "wires": [
            []
        ]
    },
    {
        "id": "ace5946d.25c408",
        "type": "ui_text",
        "z": "b49784d.ed72f78",
        "group": "674fae8.56f1e5",
        "order": 1,
        "width": 0,
        "height": 0,
        "name": "",
        "label": "text",
        "format": "{{msg.payload}}",
        "layout": "row-spread",
        "x": 440,
        "y": 640,
        "wires": []
    },
    {
        "id": "47aaa714.fd5c78",
        "type": "mqtt in",
        "z": "ca426e9f.74914",
        "name": "",
        "topic": "bracelet/auth/connect/#",
        "qos": "2",
        "datatype": "auto",
        "broker": "c9a66da.209299",
        "x": 320,
        "y": 340,
        "wires": [
            [
                "d8911f3e.66d5",
                "d9d2048d.fa1408"
            ]
        ]
    },
    {
        "id": "d8911f3e.66d5",
        "type": "debug",
        "z": "ca426e9f.74914",
        "name": "auth attempt log",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 560,
        "y": 400,
        "wires": []
    },
    {
        "id": "d9d2048d.fa1408",
        "type": "function",
        "z": "ca426e9f.74914",
        "name": "auth",
        "func": "let msg_clone = msg;\nmsg_clone.old = {\n    payload : msg.payload,\n    topic : msg.topic\n};\n// \nmsg_clone.payload = [msg_clone.payload];\nmsg_clone.topic = \"SELECT COUNT(*) AS exist FROM `personnel` WHERE `macBracelet` = ?;\";\n\n// node.warn(msg);\nreturn msg_clone;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 530,
        "y": 340,
        "wires": [
            [
                "9b082efa.253db"
            ]
        ]
    },
    {
        "id": "575c52ac.e736bc",
        "type": "mqtt out",
        "z": "ca426e9f.74914",
        "g": "3f880a49.478716",
        "name": "bracelet feedback",
        "topic": "",
        "qos": "",
        "retain": "",
        "broker": "c9a66da.209299",
        "x": 1870,
        "y": 340,
        "wires": []
    },
    {
        "id": "9b082efa.253db",
        "type": "mysql",
        "z": "ca426e9f.74914",
        "mydb": "455cfbb2.9d9714",
        "name": "mac adress check",
        "x": 730,
        "y": 340,
        "wires": [
            [
                "e0ba9df4.c050b",
                "fdd3c10c.c4cc"
            ]
        ]
    },
    {
        "id": "e0ba9df4.c050b",
        "type": "debug",
        "z": "ca426e9f.74914",
        "name": "query mac search log",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 980,
        "y": 400,
        "wires": []
    },
    {
        "id": "fdd3c10c.c4cc",
        "type": "function",
        "z": "ca426e9f.74914",
        "name": "auth result check",
        "func": "let msg_clone = { ...msg };\n// msg_clone.topic = msg_clone.old.topic;\nmsg_clone.payload = false;\nmsg_clone.mac = msg_clone.old.payload;\nmsg_clone.broker = msg.old.topic.substring(msg.old.topic.lastIndexOf('/') + 1);\n// delete msg_clone.old;\n// \ntry{\n    if(msg.payload != null || msg.payload != 'null'){\n        msg_clone.payload = msg.payload[0].exist === 1 ? true : false;\n    }\n    return msg_clone;\n}catch(err){\n    node.error(err);\n    return msg_clone;\n}\n// return msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 970,
        "y": 340,
        "wires": [
            [
                "6542bcf0.f29a44",
                "9b0c6c07.9faee"
            ]
        ]
    },
    {
        "id": "6542bcf0.f29a44",
        "type": "switch",
        "z": "ca426e9f.74914",
        "name": "",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "1",
                "vt": "num"
            },
            {
                "t": "eq",
                "v": "0",
                "vt": "num"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1170,
        "y": 340,
        "wires": [
            [
                "8eb62ce2.624ff",
                "791e5401.a31f0c"
            ],
            [
                "8154172a.5b6648",
                "4e51a684.18e388"
            ]
        ]
    },
    {
        "id": "9b0c6c07.9faee",
        "type": "debug",
        "z": "ca426e9f.74914",
        "name": "is auth log",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1190,
        "y": 400,
        "wires": []
    },
    {
        "id": "8eb62ce2.624ff",
        "type": "function",
        "z": "ca426e9f.74914",
        "name": "autorisé",
        "func": "let msg_clone = [{ ...msg }, { ...msg }];\n// ADD HISTORIQUE RECORD\nconst historique_action = 'connecté';\nmsg_clone[0].payload = [historique_action, msg.mac];\nmsg_clone[0].topic = \"INSERT INTO `historique` (`idHistorique`, `actionHistorique`, `dateHistorique`, `idPersonnel`) SELECT NULL, ?, NULL, `idPersonnel` FROM personnel WHERE macBracelet = ? LIMIT 1;\";\n// UPDATE ONLINE STATUS\nmsg_clone[1].payload = [msg.mac];\nmsg_clone[1].topic = \"UPDATE `personnel` SET `onlinePersonnel` = 1 WHERE `macBracelet` = ?\";\n// \nreturn msg_clone;",
        "outputs": 2,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 1340,
        "y": 220,
        "wires": [
            [
                "c8940b53.619438"
            ],
            [
                "1781abb1.f17964"
            ]
        ],
        "info": "if authorized update the personnel online status with **true**"
    },
    {
        "id": "8154172a.5b6648",
        "type": "function",
        "z": "ca426e9f.74914",
        "name": "non autorisé",
        "func": "msg.data = {};\nmsg.data.sujet = \"br_na_brace\";\nmsg.data.user = false;\nmsg.payload = false;\n//\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 1350,
        "y": 280,
        "wires": [
            [
                "ed24bb0e.8b8ef8"
            ]
        ],
        "info": "if not authorized insert a notification to database to keep track of unallowed divices connections"
    },
    {
        "id": "4e51a684.18e388",
        "type": "function",
        "z": "ca426e9f.74914",
        "g": "3f880a49.478716",
        "name": "gen topic",
        "func": "let msg_clone = { ...msg };\nconst device_channel_id = msg.old.topic.substring(msg.old.topic.lastIndexOf('/') + 1);\nmsg_clone.topic = `bracelet/auth/response/connect/${device_channel_id}`;\n//\ntry{\n    msg_clone.payload = false;\n    if(msg.payload != null && msg.payload != 'null'){\n        if(msg.payload.length == 1)\n            msg_clone.payload = JSON.stringify({msg : msg.payload[0].msg, points : msg.payload[0].points});\n    }\n    // \n    return msg_clone;\n}catch(err){\n    node.error(err);\n    msg_clone.payload = null;\n    return msg_clone;\n}",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 1680,
        "y": 340,
        "wires": [
            [
                "575c52ac.e736bc"
            ]
        ]
    },
    {
        "id": "1781abb1.f17964",
        "type": "mysql",
        "z": "ca426e9f.74914",
        "mydb": "455cfbb2.9d9714",
        "name": "update online status",
        "x": 1580,
        "y": 220,
        "wires": [
            [
                "7680845f.2aca7c",
                "ce505014.a37ee"
            ]
        ]
    },
    {
        "id": "7680845f.2aca7c",
        "type": "debug",
        "z": "ca426e9f.74914",
        "name": "online status update log",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1850,
        "y": 220,
        "wires": []
    },
    {
        "id": "c8940b53.619438",
        "type": "mysql",
        "z": "ca426e9f.74914",
        "mydb": "455cfbb2.9d9714",
        "name": "historique",
        "x": 1540,
        "y": 160,
        "wires": [
            [
                "79432d8f.36b844",
                "bd2bf81a.3be068"
            ]
        ]
    },
    {
        "id": "79432d8f.36b844",
        "type": "debug",
        "z": "ca426e9f.74914",
        "name": "historique insert log",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1750,
        "y": 160,
        "wires": []
    },
    {
        "id": "bd2bf81a.3be068",
        "type": "function",
        "z": "ca426e9f.74914",
        "name": "insertion valdiation",
        "func": "msg.data.sujet = \"db_e_s_histo\";\n// \ntry{\n    if(msg.payload != null && msg.payload != 'null')\n        msg.payload = msg.payload.affectedRows != 0 ? true : false;\n}catch(err){\n    node.error(err);\n    msg.payload = false;\n    return msg;\n}",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 1750,
        "y": 120,
        "wires": [
            [
                "ed24bb0e.8b8ef8"
            ]
        ]
    },
    {
        "id": "ce505014.a37ee",
        "type": "function",
        "z": "ca426e9f.74914",
        "name": "update validation",
        "func": "msg.data.sujet = \"db_e_u_perso\";\n// \ntry{\n    if(msg.payload != null && msg.payload != 'null')\n        msg.payload = msg.payload.affectedRows != 0 ? true : false;\n}catch(err){\n    node.error(err);\n    msg.payload = false;\n    return msg;\n}",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 1830,
        "y": 260,
        "wires": [
            [
                "ed24bb0e.8b8ef8"
            ]
        ]
    },
    {
        "id": "1d86dade.dd0fd5",
        "type": "mqtt in",
        "z": "ca426e9f.74914",
        "name": "",
        "topic": "bracelet/auth/disconnect/#",
        "qos": "2",
        "datatype": "auto",
        "broker": "c9a66da.209299",
        "x": 330,
        "y": 740,
        "wires": [
            [
                "de51f706.6bbf68"
            ]
        ]
    },
    {
        "id": "3ca71ddf.a756d2",
        "type": "mqtt in",
        "z": "ae64b298.b7071",
        "name": "",
        "topic": "bracelet/record/send/#",
        "qos": "2",
        "datatype": "auto",
        "broker": "c9a66da.209299",
        "x": 200,
        "y": 220,
        "wires": [
            [
                "7b6526b5.0e7d28",
                "38239700.8af93a"
            ]
        ],
        "info": "# payload format\n[{ data: { bc: \"\", oxy: \"\", temp: \"\" }, date: \"\" }];"
    },
    {
        "id": "7b6526b5.0e7d28",
        "type": "debug",
        "z": "ae64b298.b7071",
        "name": "received data",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 440,
        "y": 280,
        "wires": []
    },
    {
        "id": "38239700.8af93a",
        "type": "change",
        "z": "ae64b298.b7071",
        "name": "",
        "rules": [
            {
                "t": "change",
                "p": "payload",
                "pt": "msg",
                "from": "'",
                "fromt": "str",
                "to": "\"",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 460,
        "y": 220,
        "wires": [
            [
                "bff5a5f9.a67288"
            ]
        ]
    },
    {
        "id": "bff5a5f9.a67288",
        "type": "json",
        "z": "ae64b298.b7071",
        "name": "format object",
        "property": "payload",
        "action": "",
        "pretty": false,
        "x": 690,
        "y": 220,
        "wires": [
            [
                "6c707639.77da48"
            ]
        ]
    },
    {
        "id": "cff7ce90.7384d",
        "type": "function",
        "z": "ae64b298.b7071",
        "name": "build insertion query",
        "func": "msg.payload = [];\nmsg.topic = \"INSERT INTO `record` (`idRecord`, `battementCoeur`, `temperature`, `oxygene`, `dateRecord`, `idBroker`, `idPersonnel`) VALUES \";\nconst broker_id = 1;\n// \nfor (let i = 0; i < msg.old.payload.records.length; i++) {\n    const record = msg.old.payload.records[i];\n    const data = record.data;\n    // \n    msg.payload.push(data.bc,data.temp,data.oxy,record.date,broker_id,msg.old.idPers);\n    msg.topic += '(NULL, ?, ?, ?, ?, ?, ?)';\n    // \n    if(i < msg.old.payload.records.length - 1)\n        msg.topic += ', ';\n}\n// \nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 2480,
        "y": 140,
        "wires": [
            [
                "9a12b3f6.c4f4c",
                "23bfdeb7.80d242"
            ]
        ]
    },
    {
        "id": "6c707639.77da48",
        "type": "function",
        "z": "ae64b298.b7071",
        "g": "2237ecd8.c072a4",
        "name": "auth",
        "func": "let msg_clone = msg;\nmsg_clone.old = {\n    payload : msg.payload,\n    topic : msg.topic\n};\n// \nmsg_clone.payload = [msg.payload.mac];\nmsg_clone.topic = \"SELECT COUNT(*) AS exist FROM `personnel` WHERE `macBracelet` = ?;\";\n\n// node.warn(msg);\nreturn msg_clone;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 870,
        "y": 220,
        "wires": [
            [
                "e9472095.984ca"
            ]
        ]
    },
    {
        "id": "e9472095.984ca",
        "type": "mysql",
        "z": "ae64b298.b7071",
        "g": "2237ecd8.c072a4",
        "mydb": "455cfbb2.9d9714",
        "name": "mac adress check",
        "x": 1070,
        "y": 220,
        "wires": [
            [
                "5e9f5fb7.f1f81",
                "2398fb29.5e26e4"
            ]
        ]
    },
    {
        "id": "5e9f5fb7.f1f81",
        "type": "debug",
        "z": "ae64b298.b7071",
        "g": "2237ecd8.c072a4",
        "name": "query mac search log",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1320,
        "y": 280,
        "wires": []
    },
    {
        "id": "2398fb29.5e26e4",
        "type": "function",
        "z": "ae64b298.b7071",
        "g": "2237ecd8.c072a4",
        "name": "auth result check",
        "func": "let msg_clone = { ...msg };\nmsg_clone.payload = false;\nmsg_clone.broker = msg.old.topic.substring(msg.old.topic.lastIndexOf('/') + 1);\n// \ntry{\n    if(msg.payload != null || msg.payload != 'null'){\n        msg_clone.payload = msg.payload[0].exist === 1 ? true : false;\n    }\n    return msg_clone;\n}catch(err){\n    node.error(err);\n    return msg_clone;\n}\n// return msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 1310,
        "y": 220,
        "wires": [
            [
                "7fb4d405.e6e74c",
                "ff134346.7f718"
            ]
        ]
    },
    {
        "id": "7fb4d405.e6e74c",
        "type": "switch",
        "z": "ae64b298.b7071",
        "g": "2237ecd8.c072a4",
        "name": "",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "1",
                "vt": "num"
            },
            {
                "t": "eq",
                "v": "0",
                "vt": "num"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1510,
        "y": 220,
        "wires": [
            [
                "ddaa329.cdb85d"
            ],
            [
                "74421d12.f29ae4",
                "e4e23860.685698"
            ]
        ]
    },
    {
        "id": "ff134346.7f718",
        "type": "debug",
        "z": "ae64b298.b7071",
        "g": "2237ecd8.c072a4",
        "name": "is auth log",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1530,
        "y": 280,
        "wires": []
    },
    {
        "id": "fc4438f9.cb9b68",
        "type": "comment",
        "z": "ae64b298.b7071",
        "g": "527c0c5.94a06f4",
        "name": "error managment",
        "info": "adopt this model for all wanted error managment\n---\nfor now this wont work\n**solution** => add an object called .error with data {error:'notificaction_topic',msg:'error_msg'}",
        "x": 2800,
        "y": 340,
        "wires": []
    },
    {
        "id": "21abda46.d794f6",
        "type": "switch",
        "z": "ae64b298.b7071",
        "g": "527c0c5.94a06f4",
        "name": "",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "0",
                "vt": "num"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 2770,
        "y": 300,
        "wires": [
            [
                "3a21e9dc.2e3e86",
                "13814d4a.7bf2f3"
            ]
        ]
    },
    {
        "id": "f63e6857.ad89b8",
        "type": "mqtt out",
        "z": "ae64b298.b7071",
        "g": "527c0c5.94a06f4",
        "name": "inform admin",
        "topic": "",
        "qos": "",
        "retain": "",
        "broker": "c9a66da.209299",
        "x": 3650,
        "y": 300,
        "wires": []
    },
    {
        "id": "3a21e9dc.2e3e86",
        "type": "debug",
        "z": "ae64b298.b7071",
        "g": "527c0c5.94a06f4",
        "name": "error saving data",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 2970,
        "y": 300,
        "wires": []
    },
    {
        "id": "3443edf1.83d102",
        "type": "mysql",
        "z": "ae64b298.b7071",
        "g": "527c0c5.94a06f4",
        "mydb": "455cfbb2.9d9714",
        "name": "save notification",
        "x": 3240,
        "y": 240,
        "wires": [
            [
                "8305411b.4b7ed",
                "e80e10f1.2c9bb"
            ]
        ]
    },
    {
        "id": "8305411b.4b7ed",
        "type": "debug",
        "z": "ae64b298.b7071",
        "g": "527c0c5.94a06f4",
        "name": "notification save log",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 3470,
        "y": 240,
        "wires": []
    },
    {
        "id": "13814d4a.7bf2f3",
        "type": "function",
        "z": "ae64b298.b7071",
        "g": "527c0c5.94a06f4",
        "name": "prepare notification query",
        "func": "// const sujet = \"db_e_s_histo\";\nconst sujet = msg.data.sujet;\nconst broker_id = 1;\nlet date = new Date(); \ndate = date.toISOString().slice(0, 19).replace('T', ' ');\nmsg.data.date = date;\n// \nmsg.payload = [sujet, date, broker_id, msg.data.user == false ? null : msg.old.payload.mac];\nif(msg.data.user == false)\n    msg.topic = \"INSERT INTO `notification` (`idNotification`, `sujetNotification`, `dateNotification`, `idBroker`, `idPersonnel`) VALUES(NULL, ?, ?, ?, ?);\";\nelse\n    msg.topic = \"INSERT INTO `notification` (`idNotification`, `sujetNotification`, `dateNotification`, `idBroker`, `idPersonnel`) SELECT NULL, ?, ?, ?, `idPersonnel` FROM personnel WHERE macBracelet = ? LIMIT 1;\";\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 2990,
        "y": 240,
        "wires": [
            [
                "3443edf1.83d102",
                "157f1dde.cafc12"
            ]
        ]
    },
    {
        "id": "e80e10f1.2c9bb",
        "type": "function",
        "z": "ae64b298.b7071",
        "g": "527c0c5.94a06f4",
        "name": "data format",
        "func": "msg.topic = `admin/notif`;\nmsg.payload = JSON.stringify({code : msg.data.sujet, user : msg.old.payload.mac, date : msg.data.date, broker : msg.broker});\n// \nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 3450,
        "y": 300,
        "wires": [
            [
                "f63e6857.ad89b8"
            ]
        ]
    },
    {
        "id": "157f1dde.cafc12",
        "type": "debug",
        "z": "ae64b298.b7071",
        "g": "527c0c5.94a06f4",
        "name": "query log",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 3220,
        "y": 300,
        "wires": []
    },
    {
        "id": "74421d12.f29ae4",
        "type": "function",
        "z": "ae64b298.b7071",
        "name": "mac not found",
        "func": "msg.data = {};\nmsg.data.sujet = \"br_na_brace\";\nmsg.data.user = msg.old.payload.mac;\nmsg.payload = false;\n//\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 1760,
        "y": 260,
        "wires": [
            [
                "21abda46.d794f6"
            ]
        ]
    },
    {
        "id": "9a12b3f6.c4f4c",
        "type": "mysql",
        "z": "ae64b298.b7071",
        "mydb": "455cfbb2.9d9714",
        "name": "insert records",
        "x": 2720,
        "y": 160,
        "wires": [
            [
                "e2ff1819.7c84c8",
                "b35a94e4.810b28"
            ]
        ]
    },
    {
        "id": "e2ff1819.7c84c8",
        "type": "debug",
        "z": "ae64b298.b7071",
        "name": "insert res",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 2920,
        "y": 100,
        "wires": []
    },
    {
        "id": "23bfdeb7.80d242",
        "type": "debug",
        "z": "ae64b298.b7071",
        "name": "records query",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 2720,
        "y": 100,
        "wires": []
    },
    {
        "id": "b35a94e4.810b28",
        "type": "function",
        "z": "ae64b298.b7071",
        "name": "insertion valdiation",
        "func": "msg.data = {};\nmsg.data.sujet = \"db_e_s_record\";\n// \ntry{\n    if(msg.payload != null && msg.payload != 'null')\n        msg.payload = msg.payload.affectedRows != 0 ? true : false;\n    return msg;\n}catch(err){\n    node.error(err);\n    msg.payload = false;\n    return msg;\n}",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 2950,
        "y": 160,
        "wires": [
            [
                "21abda46.d794f6",
                "4867ad2c.afd334",
                "ba7ea855.7cd608"
            ]
        ]
    },
    {
        "id": "ba7ea855.7cd608",
        "type": "function",
        "z": "ae64b298.b7071",
        "name": "gen topic",
        "func": "const device_channel_id = msg.old.topic.substring(msg.old.topic.lastIndexOf('/') + 1);\nmsg.topic = `bracelet/record/response/send/${device_channel_id}`;\n// \nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 3160,
        "y": 160,
        "wires": [
            [
                "67e576de.1ab828",
                "9ca36366.a6bb2"
            ]
        ]
    },
    {
        "id": "67e576de.1ab828",
        "type": "mqtt out",
        "z": "ae64b298.b7071",
        "name": "response back to broker",
        "topic": "",
        "qos": "",
        "retain": "",
        "broker": "c9a66da.209299",
        "x": 3410,
        "y": 160,
        "wires": []
    },
    {
        "id": "4867ad2c.afd334",
        "type": "debug",
        "z": "ae64b298.b7071",
        "name": "",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 3150,
        "y": 100,
        "wires": []
    },
    {
        "id": "9ca36366.a6bb2",
        "type": "debug",
        "z": "ae64b298.b7071",
        "name": "",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 3350,
        "y": 100,
        "wires": []
    },
    {
        "id": "e4e23860.685698",
        "type": "function",
        "z": "ae64b298.b7071",
        "name": "gen topic",
        "func": "const device_channel_id = msg.old.topic.substring(msg.old.topic.lastIndexOf('/') + 1);\nmsg.topic = `bracelet/record/response/send/${device_channel_id}`;\n// \nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 1740,
        "y": 320,
        "wires": [
            [
                "14ce94da.0b18eb"
            ]
        ]
    },
    {
        "id": "14ce94da.0b18eb",
        "type": "mqtt out",
        "z": "ae64b298.b7071",
        "name": "response back to broker",
        "topic": "",
        "qos": "",
        "retain": "",
        "broker": "c9a66da.209299",
        "x": 1970,
        "y": 320,
        "wires": []
    },
    {
        "id": "7ed6431e.76591c",
        "type": "comment",
        "z": "ca426e9f.74914",
        "g": "ab4905c.3eaaef8",
        "name": "error managment",
        "info": "adopt this model for all wanted error managment\n---\nfor now this wont work\n**solution** => add an object called .error with data {error:'notificaction_topic',msg:'error_msg'}",
        "x": 2100,
        "y": 320,
        "wires": []
    },
    {
        "id": "ed24bb0e.8b8ef8",
        "type": "switch",
        "z": "ca426e9f.74914",
        "g": "ab4905c.3eaaef8",
        "name": "",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "0",
                "vt": "num"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 2070,
        "y": 280,
        "wires": [
            [
                "7adee4b2.81c55c",
                "57cac35e.049f6c"
            ]
        ]
    },
    {
        "id": "cf041cba.1e56b",
        "type": "mqtt out",
        "z": "ca426e9f.74914",
        "g": "ab4905c.3eaaef8",
        "name": "inform admin",
        "topic": "",
        "qos": "",
        "retain": "",
        "broker": "c9a66da.209299",
        "x": 2950,
        "y": 280,
        "wires": []
    },
    {
        "id": "7adee4b2.81c55c",
        "type": "debug",
        "z": "ca426e9f.74914",
        "g": "ab4905c.3eaaef8",
        "name": "error saving data",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 2270,
        "y": 280,
        "wires": []
    },
    {
        "id": "5b18bfde.29218",
        "type": "mysql",
        "z": "ca426e9f.74914",
        "g": "ab4905c.3eaaef8",
        "mydb": "455cfbb2.9d9714",
        "name": "save notification",
        "x": 2540,
        "y": 220,
        "wires": [
            [
                "a27c3507.d280f8",
                "d8737a5b.b37a18"
            ]
        ]
    },
    {
        "id": "a27c3507.d280f8",
        "type": "debug",
        "z": "ca426e9f.74914",
        "g": "ab4905c.3eaaef8",
        "name": "notification save log",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 2770,
        "y": 220,
        "wires": []
    },
    {
        "id": "57cac35e.049f6c",
        "type": "function",
        "z": "ca426e9f.74914",
        "g": "ab4905c.3eaaef8",
        "name": "prepare notification query",
        "func": "// const sujet = \"db_e_s_histo\";\nconst sujet = msg.data.sujet;\nconst broker_id = 1;\nlet date = new Date(); \ndate = date.toISOString().slice(0, 19).replace('T', ' ');\nmsg.data.date = date;\n// \nmsg.payload = [sujet, date, broker_id, msg.data.user == false ? null : msg.old.payload.mac || msg.old.payload.bracelet];\nif(msg.data.user == false)\n    msg.topic = \"INSERT INTO `notification` (`idNotification`, `sujetNotification`, `dateNotification`, `idBroker`, `idPersonnel`) VALUES(NULL, ?, ?, ?, ?);\";\nelse\n    msg.topic = \"INSERT INTO `notification` (`idNotification`, `sujetNotification`, `dateNotification`, `idBroker`, `idPersonnel`) SELECT NULL, ?, ?, ?, `idPersonnel` FROM personnel WHERE macBracelet = ? LIMIT 1;\";\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 2290,
        "y": 220,
        "wires": [
            [
                "5b18bfde.29218",
                "33b12978.ddfdf6"
            ]
        ]
    },
    {
        "id": "d8737a5b.b37a18",
        "type": "function",
        "z": "ca426e9f.74914",
        "g": "ab4905c.3eaaef8",
        "name": "data format",
        "func": "msg.topic = `admin/notif`;\nmsg.payload = JSON.stringify({code : msg.data.sujet, user : msg.mac, date : msg.data.date, broker : msg.broker});\n// \nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 2750,
        "y": 280,
        "wires": [
            [
                "cf041cba.1e56b"
            ]
        ]
    },
    {
        "id": "33b12978.ddfdf6",
        "type": "debug",
        "z": "ca426e9f.74914",
        "g": "ab4905c.3eaaef8",
        "name": "query log",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 2520,
        "y": 280,
        "wires": []
    },
    {
        "id": "7a455123.94aa8",
        "type": "comment",
        "z": "ae64b298.b7071",
        "name": "access point -to- server (server)",
        "info": "",
        "x": 230,
        "y": 60,
        "wires": []
    },
    {
        "id": "ccbaf90a.d09068",
        "type": "comment",
        "z": "ca426e9f.74914",
        "name": "access point -to- server (server)",
        "info": "",
        "x": 350,
        "y": 240,
        "wires": []
    },
    {
        "id": "104a274e.5b5e29",
        "type": "comment",
        "z": "b94f6bbb.19bb98",
        "name": "Respect de la restriction de Zone ",
        "info": "",
        "x": 130,
        "y": 140,
        "wires": []
    },
    {
        "id": "cffcba1.11f7648",
        "type": "mqtt in",
        "z": "b94f6bbb.19bb98",
        "name": "",
        "topic": "bracelet/zone/check/#",
        "qos": "2",
        "datatype": "auto",
        "broker": "c9a66da.209299",
        "x": 100,
        "y": 260,
        "wires": [
            [
                "48c43cd.c5af0c4"
            ]
        ]
    },
    {
        "id": "b251d95e.1625f8",
        "type": "comment",
        "z": "b94f6bbb.19bb98",
        "name": "{bracelet -> broker de zone} -> server (this)",
        "info": "",
        "x": 160,
        "y": 180,
        "wires": []
    },
    {
        "id": "1daed746.e386a9",
        "type": "comment",
        "z": "b94f6bbb.19bb98",
        "name": "skip auth",
        "info": "",
        "x": 700,
        "y": 320,
        "wires": []
    },
    {
        "id": "df53dae1.79b228",
        "type": "function",
        "z": "b94f6bbb.19bb98",
        "name": "zone check query",
        "func": "let msg_clone = msg;\nmsg_clone.old = {\n    payload : msg.payload,\n    topic : msg.topic\n};\nmsg_clone.payload = [msg.payload.bracelet_mac, msg.payload.broker_mac, msg.payload.bracelet_mac, msg.payload.broker_mac];\nmsg_clone.topic = \"SELECT SUM(nb) AS allowed FROM ( SELECT COUNT(idZone) AS nb FROM accesZone WHERE idPersonnel IN (SELECT idPersonnel FROM personnel WHERE macBracelet = ?) AND idZone IN (SELECT idZone FROM broker WHERE macBroker = ?) UNION ALL SELECT COUNT(idZone) AS nb FROM accesZoneTemp WHERE idPersonnel IN (SELECT idPersonnel FROM personnel WHERE macBracelet = ?) AND idZone IN (SELECT idZone FROM broker WHERE macBroker = ?) AND TIMESTAMPDIFF(SECOND, NOW(), dateF_AccesZT) >= 0 AND TIMESTAMPDIFF(SECOND, dateD_AccesZT, NOW()) >= 0 )a\"\n// \nreturn msg_clone;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 810,
        "y": 260,
        "wires": [
            [
                "3dbaf5ff.51772a"
            ]
        ]
    },
    {
        "id": "3dbaf5ff.51772a",
        "type": "mysql",
        "z": "b94f6bbb.19bb98",
        "mydb": "455cfbb2.9d9714",
        "name": "",
        "x": 1020,
        "y": 260,
        "wires": [
            [
                "f94d1919.addf78",
                "1ab533fc.9dc41c"
            ]
        ]
    },
    {
        "id": "48c43cd.c5af0c4",
        "type": "change",
        "z": "b94f6bbb.19bb98",
        "name": "",
        "rules": [
            {
                "t": "change",
                "p": "payload",
                "pt": "msg",
                "from": "'",
                "fromt": "str",
                "to": "\"",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 360,
        "y": 260,
        "wires": [
            [
                "1e2465c8.38952a"
            ]
        ]
    },
    {
        "id": "1e2465c8.38952a",
        "type": "json",
        "z": "b94f6bbb.19bb98",
        "name": "format object",
        "property": "payload",
        "action": "",
        "pretty": false,
        "x": 590,
        "y": 260,
        "wires": [
            [
                "df53dae1.79b228"
            ]
        ]
    },
    {
        "id": "f94d1919.addf78",
        "type": "debug",
        "z": "b94f6bbb.19bb98",
        "name": "",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1190,
        "y": 320,
        "wires": []
    },
    {
        "id": "1ab533fc.9dc41c",
        "type": "function",
        "z": "b94f6bbb.19bb98",
        "name": "data validation",
        "func": "let msg_clone = { ...msg };\nmsg_clone.payload = false;\nmsg_clone.broker = msg.old.topic.substring(msg.old.topic.lastIndexOf('/') + 1);\n// \ntry{\n    if(msg.payload != null || msg.payload != 'null'){\n        msg_clone.payload = msg.payload[0].allowed <= 0 ? true : -1;\n    }\n    return msg_clone;\n}catch(err){\n    node.error(err);\n    return msg_clone;\n}",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 1220,
        "y": 260,
        "wires": [
            [
                "e0ca126c.e1c47"
            ]
        ]
    },
    {
        "id": "334251a2.40d31e",
        "type": "comment",
        "z": "b94f6bbb.19bb98",
        "g": "d5fedbb5.051ae8",
        "name": "error managment",
        "info": "adopt this model for all wanted error managment\n---\nfor now this wont work\n**solution** => add an object called .error with data {error:'notificaction_topic',msg:'error_msg'}",
        "x": 1680,
        "y": 440,
        "wires": []
    },
    {
        "id": "dafd61e6.39313",
        "type": "switch",
        "z": "b94f6bbb.19bb98",
        "g": "d5fedbb5.051ae8",
        "name": "",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "0",
                "vt": "num"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 1650,
        "y": 400,
        "wires": [
            [
                "648f4a50.cb96f4",
                "70e23f0e.5c754"
            ]
        ]
    },
    {
        "id": "966a1f00.144a8",
        "type": "mqtt out",
        "z": "b94f6bbb.19bb98",
        "g": "d5fedbb5.051ae8",
        "name": "inform admin",
        "topic": "",
        "qos": "",
        "retain": "",
        "broker": "c9a66da.209299",
        "x": 2530,
        "y": 400,
        "wires": []
    },
    {
        "id": "648f4a50.cb96f4",
        "type": "debug",
        "z": "b94f6bbb.19bb98",
        "g": "d5fedbb5.051ae8",
        "name": "error saving data",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1850,
        "y": 400,
        "wires": []
    },
    {
        "id": "8b323cf4.22f02",
        "type": "mysql",
        "z": "b94f6bbb.19bb98",
        "g": "d5fedbb5.051ae8",
        "mydb": "455cfbb2.9d9714",
        "name": "save notification",
        "x": 2120,
        "y": 340,
        "wires": [
            [
                "7d36d325.9a6e1c",
                "9efaa326.bd995"
            ]
        ]
    },
    {
        "id": "7d36d325.9a6e1c",
        "type": "debug",
        "z": "b94f6bbb.19bb98",
        "g": "d5fedbb5.051ae8",
        "name": "notification save log",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 2350,
        "y": 340,
        "wires": []
    },
    {
        "id": "70e23f0e.5c754",
        "type": "function",
        "z": "b94f6bbb.19bb98",
        "g": "d5fedbb5.051ae8",
        "name": "prepare notification query",
        "func": "// const sujet = \"db_e_s_histo\";\nconst sujet = msg.data.sujet;\nconst broker_id = 1;\nlet date = new Date(); \ndate = date.toISOString().slice(0, 19).replace('T', ' ');\nmsg.data.date = date;\n// \nmsg.payload = [sujet, date, broker_id, msg.data.user == false ? null : msg.old.payload.bracelet_mac];\nif(msg.data.user == false)\n    msg.topic = \"INSERT INTO `notification` (`idNotification`, `sujetNotification`, `dateNotification`, `idBroker`, `idPersonnel`) VALUES(NULL, ?, ?, ?, ?);\";\nelse\n    msg.topic = \"INSERT INTO `notification` (`idNotification`, `sujetNotification`, `dateNotification`, `idBroker`, `idPersonnel`) SELECT NULL, ?, ?, ?, `idPersonnel` FROM personnel WHERE macBracelet = ? LIMIT 1;\";\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 1870,
        "y": 340,
        "wires": [
            [
                "8b323cf4.22f02",
                "48519d4d.4a9af4"
            ]
        ]
    },
    {
        "id": "9efaa326.bd995",
        "type": "function",
        "z": "b94f6bbb.19bb98",
        "g": "d5fedbb5.051ae8",
        "name": "data format",
        "func": "msg.topic = `admin/notif`;\nmsg.payload = JSON.stringify({code : msg.data.sujet, user : msg.old.payload.bracelet_mac, date : msg.data.date, broker : msg.broker});\n// \nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 2330,
        "y": 400,
        "wires": [
            [
                "966a1f00.144a8"
            ]
        ]
    },
    {
        "id": "48519d4d.4a9af4",
        "type": "debug",
        "z": "b94f6bbb.19bb98",
        "g": "d5fedbb5.051ae8",
        "name": "query log",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 2100,
        "y": 400,
        "wires": []
    },
    {
        "id": "e0ca126c.e1c47",
        "type": "switch",
        "z": "b94f6bbb.19bb98",
        "name": "",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "1",
                "vt": "num"
            },
            {
                "t": "eq",
                "v": "0",
                "vt": "num"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1410,
        "y": 260,
        "wires": [
            [
                "13c4fd77.aa8743",
                "4fe83df.f46a7c4",
                "b1b06000.b26bb"
            ],
            [
                "303efce7.b602b4"
            ]
        ]
    },
    {
        "id": "13c4fd77.aa8743",
        "type": "debug",
        "z": "b94f6bbb.19bb98",
        "name": "",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 1730,
        "y": 140,
        "wires": []
    },
    {
        "id": "e1118e24.5d1fe",
        "type": "function",
        "z": "b94f6bbb.19bb98",
        "name": "zoneLog query",
        "func": "const zoneLog_status = '-1';\nlet date = new Date(); \ndate = date.toISOString().slice(0, 19).replace('T', ' ');\n// \nmsg.payload = [date, zoneLog_status, msg.old.payload.broker_mac, msg.old.payload.bracelet_mac];\nmsg.topic = \"INSERT INTO `zoneLog` (`idZoneLog`, `dateZoneLog`, `compteurZoneLog`, `idPersonnel`, `idBroker`) SELECT NULL, ?, ?, p.`idPersonnel`, b.`idBroker` FROM personnel AS p, broker AS b WHERE b.idBroker IN (SELECT idBroker FROM broker WHERE macBroker = ?) AND p.idPersonnel IN (SELECT idPersonnel FROM personnel WHERE macBracelet = ?)\"\n// \nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 1740,
        "y": 260,
        "wires": [
            [
                "57f1454a.f0ad4c"
            ]
        ]
    },
    {
        "id": "57f1454a.f0ad4c",
        "type": "mysql",
        "z": "b94f6bbb.19bb98",
        "mydb": "455cfbb2.9d9714",
        "name": "",
        "x": 1940,
        "y": 260,
        "wires": [
            [
                "6402ada6.6078a4",
                "f28b5582.febdb8"
            ]
        ]
    },
    {
        "id": "6402ada6.6078a4",
        "type": "debug",
        "z": "b94f6bbb.19bb98",
        "name": "",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 2130,
        "y": 200,
        "wires": []
    },
    {
        "id": "f28b5582.febdb8",
        "type": "switch",
        "z": "b94f6bbb.19bb98",
        "name": "",
        "property": "payload.affectedRows",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "1",
                "vt": "num"
            },
            {
                "t": "eq",
                "v": "0",
                "vt": "num"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 2110,
        "y": 260,
        "wires": [
            [
                "5a9cf0c1.ec57a"
            ],
            [
                "1b0e6.57085f1ab"
            ]
        ]
    },
    {
        "id": "1909171f.e83f69",
        "type": "delay",
        "z": "b94f6bbb.19bb98",
        "name": "",
        "pauseType": "delay",
        "timeout": "20",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 2500,
        "y": 260,
        "wires": [
            [
                "d34d6e2.26e909"
            ]
        ]
    },
    {
        "id": "4fe83df.f46a7c4",
        "type": "function",
        "z": "b94f6bbb.19bb98",
        "name": "Ping bracelet",
        "func": "const device_channel_id = msg.old.topic.substring(msg.old.topic.lastIndexOf('/') + 1);\nmsg.topic = `bracelet/zone/response/check/${device_channel_id}`;\nmsg.payload = JSON.stringify({code : \"z_na\", mac : msg.old.payload.bracelet_mac});\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 1730,
        "y": 100,
        "wires": [
            [
                "3ec11447.2e5bdc"
            ]
        ]
    },
    {
        "id": "3ec11447.2e5bdc",
        "type": "mqtt out",
        "z": "b94f6bbb.19bb98",
        "name": "présence non autorisé",
        "topic": "",
        "qos": "",
        "retain": "",
        "broker": "c9a66da.209299",
        "x": 1960,
        "y": 100,
        "wires": []
    },
    {
        "id": "5a9cf0c1.ec57a",
        "type": "function",
        "z": "b94f6bbb.19bb98",
        "name": "affect insertId",
        "func": "msg.contextId = msg.payload.insertId;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 2300,
        "y": 260,
        "wires": [
            [
                "e98a1017.fb29e"
            ]
        ]
    },
    {
        "id": "c16b134a.ac20d",
        "type": "function",
        "z": "b94f6bbb.19bb98",
        "name": "ensure record",
        "func": "msg.payload = [msg.old.payload.bracelet_mac];\nmsg.topic = \"SELECT `zoneLog`.*, broker.idZone FROM `zoneLog`, `broker` WHERE `broker`.idBroker = `zoneLog`.idBroker AND idPersonnel IN (SELECT idPersonnel FROM personnel WHERE macBracelet = ?) ORDER BY `dateZoneLog` DESC\";\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 2880,
        "y": 260,
        "wires": [
            [
                "c1e82a8a.47c808"
            ]
        ]
    },
    {
        "id": "4587a3bd.9a944c",
        "type": "debug",
        "z": "b94f6bbb.19bb98",
        "name": "",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 3270,
        "y": 320,
        "wires": []
    },
    {
        "id": "c1e82a8a.47c808",
        "type": "mysql",
        "z": "b94f6bbb.19bb98",
        "mydb": "455cfbb2.9d9714",
        "name": "",
        "x": 3080,
        "y": 260,
        "wires": [
            [
                "4587a3bd.9a944c",
                "695e57da.f9db78"
            ]
        ]
    },
    {
        "id": "695e57da.f9db78",
        "type": "function",
        "z": "b94f6bbb.19bb98",
        "name": "check if is last",
        "func": "msg.preload = msg.payload;\nif(msg.payload.length > 0){\n    msg.payload = msg.payload[0].idZoneLog == msg.contextId ? true : false;\n}else msg.payload = -1;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 3280,
        "y": 260,
        "wires": [
            [
                "f2a351.8821dcb"
            ]
        ]
    },
    {
        "id": "f2a351.8821dcb",
        "type": "switch",
        "z": "b94f6bbb.19bb98",
        "name": "",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "1",
                "vt": "num"
            },
            {
                "t": "eq",
                "v": "-1",
                "vt": "num"
            },
            {
                "t": "eq",
                "v": "0",
                "vt": "num"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 3,
        "x": 3470,
        "y": 260,
        "wires": [
            [
                "ba15acfb.422eb"
            ],
            [],
            [
                "b17095b2.073b38"
            ]
        ]
    },
    {
        "id": "b17095b2.073b38",
        "type": "function",
        "z": "b94f6bbb.19bb98",
        "name": "check if in zone",
        "func": "msg.payload = msg.preload[0].idZone == msg.zone ? true : false;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 3660,
        "y": 280,
        "wires": [
            [
                "722bd18a.a3b48"
            ]
        ]
    },
    {
        "id": "b1b06000.b26bb",
        "type": "function",
        "z": "b94f6bbb.19bb98",
        "name": "broker zone",
        "func": "msg.payload = [msg.old.payload.broker_mac];\nmsg.topic = \"SELECT idZone FROM broker WHERE macBroker = ?\";\n// \nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 1630,
        "y": 200,
        "wires": [
            [
                "b7f1dd6e.aa5f4"
            ]
        ]
    },
    {
        "id": "b7f1dd6e.aa5f4",
        "type": "mysql",
        "z": "b94f6bbb.19bb98",
        "mydb": "455cfbb2.9d9714",
        "name": "",
        "x": 1800,
        "y": 200,
        "wires": [
            [
                "ca5f3b98.72acb8"
            ]
        ]
    },
    {
        "id": "ca5f3b98.72acb8",
        "type": "function",
        "z": "b94f6bbb.19bb98",
        "name": "set zone",
        "func": "msg.zone = msg.payload[0].idZone;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 1940,
        "y": 200,
        "wires": [
            [
                "e1118e24.5d1fe"
            ]
        ]
    },
    {
        "id": "d34d6e2.26e909",
        "type": "delay",
        "z": "b94f6bbb.19bb98",
        "name": "",
        "pauseType": "delay",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 2680,
        "y": 260,
        "wires": [
            [
                "5bf240d8.3e375",
                "96703762.ab5ee8"
            ]
        ]
    },
    {
        "id": "ba15acfb.422eb",
        "type": "function",
        "z": "b94f6bbb.19bb98",
        "name": "",
        "func": "msg.p_next = true;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 3640,
        "y": 220,
        "wires": [
            [
                "1e56b6cc.c89769"
            ]
        ]
    },
    {
        "id": "722bd18a.a3b48",
        "type": "switch",
        "z": "b94f6bbb.19bb98",
        "name": "",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "1",
                "vt": "num"
            },
            {
                "t": "eq",
                "v": "0",
                "vt": "num"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 3850,
        "y": 280,
        "wires": [
            [
                "98e2d84.56dbb28"
            ],
            []
        ]
    },
    {
        "id": "98e2d84.56dbb28",
        "type": "function",
        "z": "b94f6bbb.19bb98",
        "name": "",
        "func": "msg.p_next = false;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 4020,
        "y": 280,
        "wires": [
            [
                "1e56b6cc.c89769"
            ]
        ]
    },
    {
        "id": "1e56b6cc.c89769",
        "type": "function",
        "z": "b94f6bbb.19bb98",
        "name": "update time query",
        "func": "msg.payload = [5, msg.contextId];\nmsg.topic = \"UPDATE zoneLog SET compteurZoneLog = compteurZoneLog + ? WHERE idZoneLog = ?\";\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 3890,
        "y": 340,
        "wires": [
            [
                "9b834e6b.61022"
            ]
        ]
    },
    {
        "id": "b0abed4f.364fe",
        "type": "function",
        "z": "b94f6bbb.19bb98",
        "name": "insert charge query",
        "func": "// const raison = `Ne pas maintenir la distance sociale`;\nconst raison = `Zone non autoriser`;\nlet date = new Date(); \ndate = date.toISOString().slice(0, 19).replace('T', ' ');\n// \nmsg.payload = [raison, date, -5, msg.old.payload.bracelet_mac, msg.old.payload.broker_mac];\nmsg.topic = \"INSERT INTO `recordPoints` (`idRecordPoints`, `raisonRecordPoints`, `dateRecordPoints`, `nbPoints`, `idBroker`, `idPersonnel`) SELECT NULL, ?, ?, ?, idBroker, idPersonnel FROM personnel AS p, broker AS b WHERE idPersonnel IN (SELECT idPersonnel FROM personnel WHERE macBracelet = ?) AND idBroker IN (SELECT idBroker FROM broker WHERE macBroker = ?)\";\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 4310,
        "y": 340,
        "wires": [
            [
                "fa9d85a3.6fc8d8",
                "b58dc9a6.701138"
            ]
        ]
    },
    {
        "id": "9b834e6b.61022",
        "type": "mysql",
        "z": "b94f6bbb.19bb98",
        "mydb": "455cfbb2.9d9714",
        "name": "",
        "x": 4100,
        "y": 340,
        "wires": [
            [
                "b0abed4f.364fe",
                "c6111d90.00146"
            ]
        ]
    },
    {
        "id": "fa9d85a3.6fc8d8",
        "type": "mysql",
        "z": "b94f6bbb.19bb98",
        "mydb": "455cfbb2.9d9714",
        "name": "",
        "x": 4540,
        "y": 340,
        "wires": [
            [
                "24692553.77c1ea",
                "4ac46458.6a79ec",
                "54f6d0cc.4dc2a"
            ]
        ]
    },
    {
        "id": "4ac46458.6a79ec",
        "type": "switch",
        "z": "b94f6bbb.19bb98",
        "name": "",
        "property": "p_next",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "1",
                "vt": "num"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 4710,
        "y": 340,
        "wires": [
            [
                "d34d6e2.26e909"
            ]
        ]
    },
    {
        "id": "4b366bf7.946e04",
        "type": "function",
        "z": "b94f6bbb.19bb98",
        "name": "error check",
        "func": "try{\n    if(msg.payload != null && msg.payload != 'null')\n        msg.payload = msg.payload.affectedRows != 0 ? true : false;\n    return msg;\n}catch(err){\n    node.error(err);\n    msg.payload = false;\n    return msg;\n}",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 4330,
        "y": 400,
        "wires": [
            [
                "dafd61e6.39313"
            ]
        ]
    },
    {
        "id": "c6111d90.00146",
        "type": "function",
        "z": "b94f6bbb.19bb98",
        "name": "",
        "func": "msg.data = {};\nmsg.data.sujet = \"db_e_u_zoneLog\";\n// \nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 4100,
        "y": 400,
        "wires": [
            [
                "4b366bf7.946e04"
            ]
        ]
    },
    {
        "id": "24692553.77c1ea",
        "type": "function",
        "z": "b94f6bbb.19bb98",
        "name": "",
        "func": "msg.data = {};\nmsg.data.sujet = \"db_e_s_recordPoints\";\n// \nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 4520,
        "y": 400,
        "wires": [
            [
                "4b366bf7.946e04"
            ]
        ]
    },
    {
        "id": "e98a1017.fb29e",
        "type": "function",
        "z": "b94f6bbb.19bb98",
        "name": "check query",
        "func": "msg.payload = [msg.zone, msg.old.payload.bracelet_mac];\nmsg.topic = \"SELECT IFNULL(SUM(`compteurZoneLog`), -1) as `count` FROM `zoneLog` WHERE `idBroker` IN (SELECT `idBroker` FROM broker WHERE idZone = ?) AND idPersonnel IN (SELECT idPersonnel FROM personnel WHERE macBracelet = ?)\"\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 2310,
        "y": 200,
        "wires": [
            [
                "e6b37e56.b9a83"
            ]
        ]
    },
    {
        "id": "e6b37e56.b9a83",
        "type": "mysql",
        "z": "b94f6bbb.19bb98",
        "mydb": "455cfbb2.9d9714",
        "name": "",
        "x": 2500,
        "y": 200,
        "wires": [
            [
                "87b782b0.4f16f",
                "802c4b1e.aa19a8"
            ]
        ]
    },
    {
        "id": "802c4b1e.aa19a8",
        "type": "switch",
        "z": "b94f6bbb.19bb98",
        "name": "",
        "property": "payload[0].count",
        "propertyType": "msg",
        "rules": [
            {
                "t": "lte",
                "v": "-1",
                "vt": "num"
            },
            {
                "t": "gte",
                "v": "0",
                "vt": "num"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 2670,
        "y": 200,
        "wires": [
            [
                "1909171f.e83f69",
                "6b9a8972.4bca98"
            ],
            [
                "d34d6e2.26e909"
            ]
        ]
    },
    {
        "id": "b58dc9a6.701138",
        "type": "debug",
        "z": "b94f6bbb.19bb98",
        "name": "insert query",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 4550,
        "y": 280,
        "wires": []
    },
    {
        "id": "84aa5d62.92dfe",
        "type": "comment",
        "z": "b94f6bbb.19bb98",
        "name": "check if >= 600 then closure",
        "info": "",
        "x": 2780,
        "y": 560,
        "wires": []
    },
    {
        "id": "54f6d0cc.4dc2a",
        "type": "debug",
        "z": "b94f6bbb.19bb98",
        "name": "",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 4730,
        "y": 400,
        "wires": []
    },
    {
        "id": "87b782b0.4f16f",
        "type": "debug",
        "z": "b94f6bbb.19bb98",
        "name": "",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 2650,
        "y": 140,
        "wires": []
    },
    {
        "id": "6b9a8972.4bca98",
        "type": "function",
        "z": "b94f6bbb.19bb98",
        "name": "init counter to 0",
        "func": "msg.payload = [0, msg.contextId];\nmsg.topic = \"UPDATE zoneLog SET compteurZoneLog = ? WHERE idZoneLog = ?\";\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 2880,
        "y": 140,
        "wires": [
            [
                "1d90ddc.e707022"
            ]
        ]
    },
    {
        "id": "1d90ddc.e707022",
        "type": "mysql",
        "z": "b94f6bbb.19bb98",
        "mydb": "455cfbb2.9d9714",
        "name": "",
        "x": 3080,
        "y": 140,
        "wires": [
            [
                "4294f052.6beec"
            ]
        ]
    },
    {
        "id": "4294f052.6beec",
        "type": "debug",
        "z": "b94f6bbb.19bb98",
        "name": "",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 3270,
        "y": 140,
        "wires": []
    },
    {
        "id": "303efce7.b602b4",
        "type": "function",
        "z": "b94f6bbb.19bb98",
        "name": "",
        "func": "msg.data = {};\nmsg.data.sujet = \"co_br_brZo\";\nmsg.data.user = true;\n// \nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 1460,
        "y": 340,
        "wires": [
            [
                "dafd61e6.39313"
            ]
        ]
    },
    {
        "id": "1b0e6.57085f1ab",
        "type": "function",
        "z": "b94f6bbb.19bb98",
        "name": "",
        "func": "msg.data = {};\nmsg.data.sujet = \"db_e_s_zoneLog\";\nmsg.data.user = true;\n// \nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 1460,
        "y": 400,
        "wires": [
            [
                "dafd61e6.39313"
            ]
        ]
    },
    {
        "id": "5bf240d8.3e375",
        "type": "function",
        "z": "b94f6bbb.19bb98",
        "name": "10min check query",
        "func": "const zoneId = msg.zone;\nconst userMac = msg.old.payload.bracelet_mac;\nconst timeInterval = 10; // in minutes\n// \nmsg.payload = [timeInterval, userMac, zoneId];\nmsg.topic = \"SELECT DISTINCT IFNULL(SUM(`compteurZoneLog`), 0) AS timeSpent FROM `zoneLog` WHERE TIMESTAMPDIFF(MINUTE, dateZoneLog, now()) <= ? AND idPersonnel IN (SELECT idPersonnel FROM personnel WHERE macBracelet = ?) AND idBroker IN (SELECT idbroker FROM broker WHERE idZone = ?) ORDER BY dateZoneLog DESC\"\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 2670,
        "y": 500,
        "wires": [
            [
                "e3cbb370.8d11a"
            ]
        ]
    },
    {
        "id": "e3cbb370.8d11a",
        "type": "mysql",
        "z": "b94f6bbb.19bb98",
        "mydb": "455cfbb2.9d9714",
        "name": "",
        "x": 2860,
        "y": 500,
        "wires": [
            [
                "4350379.1524ec8",
                "ebe8c65e.8a8d98"
            ]
        ]
    },
    {
        "id": "4350379.1524ec8",
        "type": "switch",
        "z": "b94f6bbb.19bb98",
        "name": "",
        "property": "payload[0].timeSpent",
        "propertyType": "msg",
        "rules": [
            {
                "t": "lt",
                "v": "600",
                "vt": "num"
            },
            {
                "t": "gte",
                "v": "600",
                "vt": "num"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 3010,
        "y": 500,
        "wires": [
            [
                "c16b134a.ac20d"
            ],
            [
                "c0e69c4e.6fd8d"
            ]
        ]
    },
    {
        "id": "c0e69c4e.6fd8d",
        "type": "function",
        "z": "b94f6bbb.19bb98",
        "name": "inform manager",
        "func": "msg.data = {};\nmsg.data.sujet = \"br_na_z\";\nmsg.data.user = true;\nmsg.payload = false;\n// \nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 3180,
        "y": 500,
        "wires": [
            [
                "dafd61e6.39313"
            ]
        ]
    },
    {
        "id": "ebe8c65e.8a8d98",
        "type": "debug",
        "z": "b94f6bbb.19bb98",
        "name": "",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 3030,
        "y": 560,
        "wires": []
    },
    {
        "id": "6f97d889.c39668",
        "type": "mqtt in",
        "z": "f13b69cc.303b38",
        "name": "",
        "topic": "bracelet/convergence/send/#",
        "qos": "2",
        "datatype": "auto",
        "broker": "c9a66da.209299",
        "x": 240,
        "y": 220,
        "wires": [
            [
                "660a4430.021c4c"
            ]
        ]
    },
    {
        "id": "1e29b735.8fadc9",
        "type": "comment",
        "z": "f13b69cc.303b38",
        "name": "Distance sociale ",
        "info": "",
        "x": 200,
        "y": 160,
        "wires": []
    },
    {
        "id": "660a4430.021c4c",
        "type": "change",
        "z": "f13b69cc.303b38",
        "name": "",
        "rules": [
            {
                "t": "change",
                "p": "payload",
                "pt": "msg",
                "from": "'",
                "fromt": "str",
                "to": "\"",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 520,
        "y": 220,
        "wires": [
            [
                "81e23bf4.020788"
            ]
        ]
    },
    {
        "id": "81e23bf4.020788",
        "type": "json",
        "z": "f13b69cc.303b38",
        "name": "format object",
        "property": "payload",
        "action": "",
        "pretty": false,
        "x": 750,
        "y": 220,
        "wires": [
            [
                "61addfa2.351cf"
            ]
        ]
    },
    {
        "id": "61addfa2.351cf",
        "type": "function",
        "z": "f13b69cc.303b38",
        "name": "",
        "func": "let msg_clone = msg;\nmsg_clone.old = {\n    payload : msg.payload,\n    topic : msg.topic\n};\n// \nmsg_clone.payload = msg_clone.payload.data && msg_clone.payload.data.length > 0 ? true : false;\n// \nreturn msg_clone;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 940,
        "y": 220,
        "wires": [
            [
                "9ed2f16b.8ded3"
            ]
        ]
    },
    {
        "id": "7e16dabe.c0cb14",
        "type": "catch",
        "z": "ca426e9f.74914",
        "name": "",
        "scope": null,
        "uncaught": true,
        "x": 1740,
        "y": 300,
        "wires": [
            [
                "a687f372.d36b6",
                "2eb6ce4d.5c0442"
            ]
        ]
    },
    {
        "id": "a687f372.d36b6",
        "type": "function",
        "z": "ca426e9f.74914",
        "name": "",
        "func": "msg.data.sujet = msg.error.message;\nmsg.payload = false;\nmsg.data.user = false;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 1920,
        "y": 300,
        "wires": [
            [
                "ed24bb0e.8b8ef8"
            ]
        ]
    },
    {
        "id": "3b4c59c8.7eec76",
        "type": "function",
        "z": "b94f6bbb.19bb98",
        "name": "",
        "func": "msg.data.sujet = msg.error.message;\nmsg.payload = false;\nmsg.data.user = false;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 1460,
        "y": 460,
        "wires": [
            [
                "dafd61e6.39313"
            ]
        ]
    },
    {
        "id": "1008dd1c.7669a3",
        "type": "catch",
        "z": "b94f6bbb.19bb98",
        "name": "",
        "scope": null,
        "uncaught": true,
        "x": 1280,
        "y": 460,
        "wires": [
            [
                "3b4c59c8.7eec76"
            ]
        ]
    },
    {
        "id": "9ed2f16b.8ded3",
        "type": "switch",
        "z": "f13b69cc.303b38",
        "name": "",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "1",
                "vt": "num"
            },
            {
                "t": "eq",
                "v": "0",
                "vt": "num"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1110,
        "y": 220,
        "wires": [
            [
                "22d79761.95c638"
            ],
            [
                "f1a83587.dc3c88"
            ]
        ]
    },
    {
        "id": "ea1062c9.aa038",
        "type": "function",
        "z": "f13b69cc.303b38",
        "name": "prepare insert query",
        "func": "const data = msg.old.payload.data[0];\n// \nmsg.payload = [data.date, data.distance, msg.old.payload.broker, data.bracelet_1, data.bracelet_2];\nmsg.topic = \"INSERT INTO convergence (`idConvergence`, `dateConvergence`, `distanceConvergence`, `idBroker`, `idPersonnel`, `idPersonnel_2`) SELECT NULL, ?, ?, br.idBroker, pr1.idPersonnel, pr2.idPersonnel FROM broker AS br, personnel AS pr1, personnel AS pr2 WHERE br.idBroker IN (SELECT idBroker FROM broker WHERE macBroker = ?) AND pr1.idPersonnel IN (SELECT idPersonnel FROM personnel WHERE macBracelet = ?) AND pr2.idPersonnel IN (SELECT idPersonnel FROM personnel WHERE macBracelet = ?)\";\n// \nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 1920,
        "y": 220,
        "wires": [
            [
                "789bf219.3a1bcc"
            ]
        ]
    },
    {
        "id": "789bf219.3a1bcc",
        "type": "mysql",
        "z": "f13b69cc.303b38",
        "mydb": "455cfbb2.9d9714",
        "name": "",
        "x": 2140,
        "y": 220,
        "wires": [
            [
                "674a3329.f5622c",
                "368c163b.16d30a"
            ]
        ]
    },
    {
        "id": "22d79761.95c638",
        "type": "function",
        "z": "f13b69cc.303b38",
        "name": "search for duplicates",
        "func": "const data = msg.old.payload.data[0];\nconst delay_interval = 5;\n// \nmsg.payload = [data.bracelet_1, data.bracelet_2, data.bracelet_1, data.bracelet_2, data.date, delay_interval, delay_interval, data.distance];\nmsg.topic = \"SELECT COUNT(*) as `exist` FROM `convergence` WHERE `idPersonnel` IN (SELECT `idPersonnel` FROM personnel WHERE macBracelet = ? OR `idPersonnel` IN (SELECT `idPersonnel` FROM personnel WHERE macBracelet = ?)) AND `idPersonnel_2` IN (SELECT `idPersonnel` FROM personnel WHERE macBracelet = ? OR `idPersonnel_2` IN (SELECT `idPersonnel` FROM personnel WHERE macBracelet = ?)) AND TIMESTAMPDIFF(SECOND, `dateConvergence`, ?) BETWEEN -? AND ? AND CAST(`distanceConvergence` AS CHAR) = ?\"\n// \nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 1320,
        "y": 220,
        "wires": [
            [
                "51b1fa18.a9b284",
                "ab8a9aec.f930c8"
            ]
        ]
    },
    {
        "id": "51b1fa18.a9b284",
        "type": "mysql",
        "z": "f13b69cc.303b38",
        "mydb": "455cfbb2.9d9714",
        "name": "",
        "x": 1540,
        "y": 220,
        "wires": [
            [
                "ef3ca338.c6b33",
                "89751b87.2b0098"
            ]
        ]
    },
    {
        "id": "ef3ca338.c6b33",
        "type": "switch",
        "z": "f13b69cc.303b38",
        "name": "",
        "property": "payload[0].exist",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "0",
                "vt": "num"
            },
            {
                "t": "gt",
                "v": "0",
                "vt": "num"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1710,
        "y": 220,
        "wires": [
            [
                "ea1062c9.aa038"
            ],
            [
                "30be031d.354c8c"
            ]
        ]
    },
    {
        "id": "30be031d.354c8c",
        "type": "function",
        "z": "f13b69cc.303b38",
        "name": "",
        "func": "if(msg.old.payload.data.length > 1){\n    msg.old.payload.data.shift();\n    msg.payload = true;\n}else msg.payload = false;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 1280,
        "y": 140,
        "wires": [
            [
                "7a91074a.ad0038"
            ]
        ]
    },
    {
        "id": "7a91074a.ad0038",
        "type": "switch",
        "z": "f13b69cc.303b38",
        "name": "",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "0",
                "vt": "num"
            },
            {
                "t": "eq",
                "v": "1",
                "vt": "num"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1430,
        "y": 140,
        "wires": [
            [
                "4ce09f46.72a13"
            ],
            [
                "22d79761.95c638"
            ]
        ]
    },
    {
        "id": "89751b87.2b0098",
        "type": "debug",
        "z": "f13b69cc.303b38",
        "name": "",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload[0].exist",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1760,
        "y": 280,
        "wires": []
    },
    {
        "id": "674a3329.f5622c",
        "type": "debug",
        "z": "f13b69cc.303b38",
        "name": "",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 2330,
        "y": 280,
        "wires": []
    },
    {
        "id": "4ce09f46.72a13",
        "type": "debug",
        "z": "f13b69cc.303b38",
        "name": "",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 1680,
        "y": 120,
        "wires": []
    },
    {
        "id": "368c163b.16d30a",
        "type": "function",
        "z": "f13b69cc.303b38",
        "name": "",
        "func": "msg.data = {};\nmsg.data.sujet = \"db_e_s_convergence\";\nmsg.data.user = true;\ntry{\n    if(msg.payload != null && msg.payload != 'null')\n        msg.payload = msg.payload.affectedRows != 0 ? true : false;\n    return msg;\n}catch(err){\n    node.error(err);\n    msg.payload = false;\n    return msg;\n}",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 2320,
        "y": 220,
        "wires": [
            [
                "549481f9.7d691"
            ]
        ]
    },
    {
        "id": "4c2c8fe.5836a7",
        "type": "comment",
        "z": "f13b69cc.303b38",
        "g": "34b503d8.c99a4c",
        "name": "error managment",
        "info": "adopt this model for all wanted error managment\n---\nfor now this wont work\n**solution** => add an object called .error with data {error:'notificaction_topic',msg:'error_msg'}",
        "x": 2660,
        "y": 400,
        "wires": []
    },
    {
        "id": "f1a83587.dc3c88",
        "type": "switch",
        "z": "f13b69cc.303b38",
        "g": "34b503d8.c99a4c",
        "name": "",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "0",
                "vt": "num"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 2630,
        "y": 360,
        "wires": [
            [
                "171ff356.0236fd",
                "91d54218.1842f"
            ]
        ]
    },
    {
        "id": "4c3b3373.572dcc",
        "type": "mqtt out",
        "z": "f13b69cc.303b38",
        "g": "34b503d8.c99a4c",
        "name": "inform admin",
        "topic": "",
        "qos": "",
        "retain": "",
        "broker": "c9a66da.209299",
        "x": 3510,
        "y": 360,
        "wires": []
    },
    {
        "id": "171ff356.0236fd",
        "type": "debug",
        "z": "f13b69cc.303b38",
        "g": "34b503d8.c99a4c",
        "name": "error saving data",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 2830,
        "y": 360,
        "wires": []
    },
    {
        "id": "4af4e024.55264",
        "type": "mysql",
        "z": "f13b69cc.303b38",
        "g": "34b503d8.c99a4c",
        "mydb": "455cfbb2.9d9714",
        "name": "save notification",
        "x": 3100,
        "y": 300,
        "wires": [
            [
                "d0f4e31a.6ec83",
                "d00b5522.859dd8"
            ]
        ]
    },
    {
        "id": "d0f4e31a.6ec83",
        "type": "debug",
        "z": "f13b69cc.303b38",
        "g": "34b503d8.c99a4c",
        "name": "notification save log",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 3330,
        "y": 300,
        "wires": []
    },
    {
        "id": "91d54218.1842f",
        "type": "function",
        "z": "f13b69cc.303b38",
        "g": "34b503d8.c99a4c",
        "name": "prepare notification query",
        "func": "// const sujet = \"db_e_s_histo\";\nconst sujet = msg.data.sujet;\nconst broker_id = 1;\nlet date = new Date(); \ndate = date.toISOString().slice(0, 19).replace('T', ' ');\nmsg.data.date = date;\n// \nmsg.payload = [sujet, date, broker_id, msg.data.user == false ? null : `${msg.old.payload.data[0].bracelet_1}|${msg.old.payload.data[0].bracelet_2}`];\nif(msg.data.user == false)\n    msg.topic = \"INSERT INTO `notification` (`idNotification`, `sujetNotification`, `dateNotification`, `idBroker`, `idPersonnel`) VALUES(NULL, ?, ?, ?, ?);\";\nelse\n    msg.topic = \"INSERT INTO `notification` (`idNotification`, `sujetNotification`, `dateNotification`, `idBroker`, `idPersonnel`) SELECT NULL, ?, ?, ?, `idPersonnel` FROM personnel WHERE macBracelet = ? LIMIT 1;\";\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 2850,
        "y": 300,
        "wires": [
            [
                "4af4e024.55264",
                "78f77e72.d99bb"
            ]
        ]
    },
    {
        "id": "d00b5522.859dd8",
        "type": "function",
        "z": "f13b69cc.303b38",
        "g": "34b503d8.c99a4c",
        "name": "data format",
        "func": "msg.topic = `admin/notif`;\nmsg.payload = JSON.stringify({code : msg.data.sujet, user : msg.old.payload.bracelet_mac, date : msg.data.date, broker : msg.broker});\n// \nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 3310,
        "y": 360,
        "wires": [
            [
                "4c3b3373.572dcc"
            ]
        ]
    },
    {
        "id": "78f77e72.d99bb",
        "type": "debug",
        "z": "f13b69cc.303b38",
        "g": "34b503d8.c99a4c",
        "name": "query log",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 3080,
        "y": 360,
        "wires": []
    },
    {
        "id": "549481f9.7d691",
        "type": "switch",
        "z": "f13b69cc.303b38",
        "name": "",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "1",
                "vt": "num"
            },
            {
                "t": "eq",
                "v": "0",
                "vt": "num"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 2470,
        "y": 220,
        "wires": [
            [
                "84a4e552.097508"
            ],
            [
                "f1a83587.dc3c88"
            ]
        ]
    },
    {
        "id": "84a4e552.097508",
        "type": "function",
        "z": "f13b69cc.303b38",
        "name": "insert into recordpoints",
        "func": "const raison = `Ne pas maintenir la distance sociale`;\nconst data = msg.old.payload.data[0];\nlet date = new Date(); \ndate = date.toISOString().slice(0, 19).replace('T', ' ');\nconst points = data.distance >= 1 ? data.distance < 1.5 ? -5 : 0 : -15;\n// \nif(points != 0){\n    msg.payload = [raison, date, points, data.bracelet_1, msg.old.payload.broker, raison, date, points, data.bracelet_2, msg.old.payload.broker];\n    msg.topic = \"INSERT INTO `recordPoints` (`idRecordPoints`, `raisonRecordPoints`, `dateRecordPoints`, `nbPoints`, `idBroker`, `idPersonnel`) (SELECT NULL, ?, ?, ?, idBroker, idPersonnel FROM personnel AS p, broker AS b WHERE idPersonnel IN (SELECT idPersonnel FROM personnel WHERE macBracelet = ?) AND idBroker IN (SELECT idBroker FROM broker WHERE macBroker = ?)) UNION ALL (SELECT NULL, ?, ?, ?, idBroker, idPersonnel FROM personnel AS p, broker AS b WHERE idPersonnel IN (SELECT idPersonnel FROM personnel WHERE macBracelet = ?) AND idBroker IN (SELECT idBroker FROM broker WHERE macBroker = ?))\";\n}else msg.payload = false;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 2680,
        "y": 220,
        "wires": [
            [
                "d8860611.938ef8",
                "5102f00c.89a7b"
            ]
        ]
    },
    {
        "id": "d8860611.938ef8",
        "type": "switch",
        "z": "f13b69cc.303b38",
        "name": "",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "neq",
                "v": "0",
                "vt": "num"
            },
            {
                "t": "false"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 2890,
        "y": 220,
        "wires": [
            [
                "45215232.c21d4c"
            ],
            [
                "30be031d.354c8c"
            ]
        ]
    },
    {
        "id": "45215232.c21d4c",
        "type": "mysql",
        "z": "f13b69cc.303b38",
        "mydb": "455cfbb2.9d9714",
        "name": "",
        "x": 3060,
        "y": 220,
        "wires": [
            [
                "11cedd19.c1c113",
                "8cda5998.9fcf98"
            ]
        ]
    },
    {
        "id": "11cedd19.c1c113",
        "type": "function",
        "z": "f13b69cc.303b38",
        "name": "",
        "func": "msg.data = {};\nmsg.data.sujet = \"db_e_s_recordPoints\";\nmsg.data.user = true;\ntry{\n    if(msg.payload != null && msg.payload != 'null')\n        msg.payload = msg.payload.affectedRows != 0 ? true : false;\n    return msg;\n}catch(err){\n    node.error(err);\n    msg.payload = false;\n    return msg;\n}",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 3240,
        "y": 220,
        "wires": [
            [
                "f1a83587.dc3c88",
                "30be031d.354c8c"
            ]
        ]
    },
    {
        "id": "5102f00c.89a7b",
        "type": "debug",
        "z": "f13b69cc.303b38",
        "name": "",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 2940,
        "y": 120,
        "wires": []
    },
    {
        "id": "8cda5998.9fcf98",
        "type": "debug",
        "z": "f13b69cc.303b38",
        "name": "",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 3300,
        "y": 140,
        "wires": []
    },
    {
        "id": "ab8a9aec.f930c8",
        "type": "debug",
        "z": "f13b69cc.303b38",
        "name": "",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 1540,
        "y": 320,
        "wires": []
    },
    {
        "id": "96703762.ab5ee8",
        "type": "function",
        "z": "b94f6bbb.19bb98",
        "name": "Ping bracelet",
        "func": "const device_channel_id = msg.old.topic.substring(msg.old.topic.lastIndexOf('/') + 1);\nmsg.topic = `bracelet/zone/response/check/${device_channel_id}`;\nmsg.payload = JSON.stringify({code : \"z_na\", mac : msg.old.payload.bracelet_mac});\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 2870,
        "y": 200,
        "wires": [
            [
                "36f6da16.e1dba6"
            ]
        ]
    },
    {
        "id": "36f6da16.e1dba6",
        "type": "mqtt out",
        "z": "b94f6bbb.19bb98",
        "name": "présence non autorisé",
        "topic": "",
        "qos": "",
        "retain": "",
        "broker": "c9a66da.209299",
        "x": 3100,
        "y": 200,
        "wires": []
    },
    {
        "id": "a1c16602.edf508",
        "type": "mqtt in",
        "z": "9137a9b2.f5e7d8",
        "name": "",
        "topic": "bracelet/queue/send/#",
        "qos": "2",
        "datatype": "auto",
        "broker": "c9a66da.209299",
        "x": 180,
        "y": 180,
        "wires": [
            [
                "fb0a40d8.8064b"
            ]
        ]
    },
    {
        "id": "fb0a40d8.8064b",
        "type": "change",
        "z": "9137a9b2.f5e7d8",
        "name": "",
        "rules": [
            {
                "t": "change",
                "p": "payload",
                "pt": "msg",
                "from": "'",
                "fromt": "str",
                "to": "\"",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 440,
        "y": 180,
        "wires": [
            [
                "824d4fb1.8a3b1"
            ]
        ]
    },
    {
        "id": "824d4fb1.8a3b1",
        "type": "json",
        "z": "9137a9b2.f5e7d8",
        "name": "format object",
        "property": "payload",
        "action": "",
        "pretty": false,
        "x": 670,
        "y": 180,
        "wires": [
            [
                "18e46e0b.ef9552"
            ]
        ]
    },
    {
        "id": "9f2d13cd.35133",
        "type": "function",
        "z": "9137a9b2.f5e7d8",
        "g": "d19f0307.1f526",
        "name": "",
        "func": "let date = new Date(); \ndate = date.toISOString().slice(0, 19).replace('T', ' ');\nmsg.old.data = date;\n// \nmsg.payload = [date, msg.old.payload.bracelet_mac, msg.old.payload.broker_mac];\nmsg.topic = \"INSERT INTO `queue` (`idQueue`, `date_TQueue`, `date_DQueue`, `date_FQueue`, `stateQueue`, `idBroker`, `idPersonnel`) SELECT NULL, ?, NULL, NULL, -1, broker.`idBroker`, personnel.`idPersonnel` FROM personnel, broker WHERE personnel.`idPersonnel` IN (SELECT `idPersonnel` FROM `personnel` WHERE macBracelet = ?) AND broker.`idBroker` IN (SELECT `idBroker` FROM broker WHERE `macBroker` = ?);\";\n// \nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 1540,
        "y": 140,
        "wires": [
            [
                "8dc420a5.e374f"
            ]
        ]
    },
    {
        "id": "18e46e0b.ef9552",
        "type": "function",
        "z": "9137a9b2.f5e7d8",
        "g": "6652510e.cda13",
        "name": "query",
        "func": "let msg_clone = msg;\nmsg_clone.old = {\n    payload : msg.payload,\n    topic : msg.topic\n};\n// \nmsg_clone.payload = [msg_clone.old.payload.bracelet_mac, msg_clone.old.payload.broker_mac];\nmsg_clone.topic = \"SELECT `stateQueue` FROM `queue` WHERE `idPersonnel` IN (SELECT `idPersonnel` FROM `personnel` WHERE macBracelet = ?) AND `idBroker` IN (SELECT `idBroker` FROM broker WHERE `macBroker` = ?) ORDER BY `date_TQueue` DESC LIMIT 1\";\n// \nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 850,
        "y": 180,
        "wires": [
            [
                "b94f667d.536148"
            ]
        ]
    },
    {
        "id": "b94f667d.536148",
        "type": "mysql",
        "z": "9137a9b2.f5e7d8",
        "g": "6652510e.cda13",
        "mydb": "455cfbb2.9d9714",
        "name": "",
        "x": 1020,
        "y": 180,
        "wires": [
            [
                "634ef386.68071c"
            ]
        ]
    },
    {
        "id": "634ef386.68071c",
        "type": "function",
        "z": "9137a9b2.f5e7d8",
        "g": "6652510e.cda13",
        "name": "",
        "func": "msg.data = {};\nmsg.data.sujet = \"db_e_f_queue\";\nmsg.data.user = true;\ntry{\n    msg.p_next = false;\n    if(msg.payload != null && msg.payload != 'null')\n        msg.p_next = msg.payload.length > 0 ? true : false;\n    return msg;\n}catch(err){\n    node.error(err);\n    msg.p_next = false;\n    return msg;\n}",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 1200,
        "y": 180,
        "wires": [
            [
                "270f6dfa.f61ac2"
            ]
        ]
    },
    {
        "id": "270f6dfa.f61ac2",
        "type": "switch",
        "z": "9137a9b2.f5e7d8",
        "g": "6652510e.cda13",
        "name": "",
        "property": "p_next",
        "propertyType": "msg",
        "rules": [
            {
                "t": "false"
            },
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1370,
        "y": 180,
        "wires": [
            [
                "9f2d13cd.35133"
            ],
            [
                "6096ba4a.4d7574"
            ]
        ]
    },
    {
        "id": "6096ba4a.4d7574",
        "type": "debug",
        "z": "9137a9b2.f5e7d8",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 1550,
        "y": 220,
        "wires": []
    },
    {
        "id": "bfea69f1.2750b8",
        "type": "comment",
        "z": "9137a9b2.f5e7d8",
        "name": "Already has a ticket",
        "info": "",
        "x": 1570,
        "y": 260,
        "wires": []
    },
    {
        "id": "8dc420a5.e374f",
        "type": "mysql",
        "z": "9137a9b2.f5e7d8",
        "g": "d19f0307.1f526",
        "mydb": "455cfbb2.9d9714",
        "name": "",
        "x": 1720,
        "y": 140,
        "wires": [
            [
                "bc720d1c.fc48e"
            ]
        ]
    },
    {
        "id": "bc720d1c.fc48e",
        "type": "function",
        "z": "9137a9b2.f5e7d8",
        "g": "d19f0307.1f526",
        "name": "",
        "func": "msg.data = {};\nmsg.data.sujet = \"db_e_s_queue\";\nmsg.data.user = true;\ntry{\n    msg.payload = false;\n    if(msg.payload != null && msg.payload != 'null')\n        msg.payload = msg.payload.affectedRows != 0 ? true : false;\n    return msg;\n}catch(err){\n    node.error(err);\n    msg.payload = false;\n    return msg;\n}",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 1900,
        "y": 140,
        "wires": [
            [
                "71b266e.530b198"
            ]
        ]
    },
    {
        "id": "71b266e.530b198",
        "type": "switch",
        "z": "9137a9b2.f5e7d8",
        "g": "d19f0307.1f526",
        "name": "",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            },
            {
                "t": "false"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 2070,
        "y": 140,
        "wires": [
            [
                "4e51ec98.0e78f4"
            ],
            [
                "2e4ad74.18d2b28"
            ]
        ]
    },
    {
        "id": "2e4ad74.18d2b28",
        "type": "debug",
        "z": "9137a9b2.f5e7d8",
        "name": "error saving",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 2250,
        "y": 220,
        "wires": []
    },
    {
        "id": "4e51ec98.0e78f4",
        "type": "function",
        "z": "9137a9b2.f5e7d8",
        "g": "96ca1e42.77651",
        "name": "",
        "func": "msg.contextId = msg.payload.insertId;\n// \nmsg.payload = [msg.old.payload.broker_mac, msg.old.payload.broker_mac, msg.old.payload.broker_mac, msg.old.date, msg.old.date, msg.old.date];\nmsg.topic = \"SELECT COUNT(`idQueue`) AS q_count FROM `queue` WHERE `stateQueue` = -1 AND `idBroker` IN (SELECT idBroker FROM broker WHERE macBroker = ?) UNION ALL SELECT COUNT(`idQueue`) AS nb_inside FROM `queue` WHERE `stateQueue` = 0 AND `idBroker` IN (SELECT idBroker FROM broker WHERE macBroker = ?) UNION ALL SELECT (COUNT(`idQueue`) + 1) AS nb_ticket FROM `queue` WHERE `idBroker` IN (SELECT idBroker FROM broker WHERE macBroker = ?) AND DAY(`date_TQueue`) = DAY(?) AND MONTH(`date_TQueue`) = MONTH(?) AND YEAR(`date_TQueue`) = YEAR(?)\";\n// \nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 2240,
        "y": 140,
        "wires": [
            [
                "9f98cfa6.bbb74"
            ]
        ]
    },
    {
        "id": "9f98cfa6.bbb74",
        "type": "mysql",
        "z": "9137a9b2.f5e7d8",
        "g": "96ca1e42.77651",
        "mydb": "455cfbb2.9d9714",
        "name": "",
        "x": 2420,
        "y": 140,
        "wires": [
            [
                "24a963eb.9ba6cc"
            ]
        ]
    },
    {
        "id": "24a963eb.9ba6cc",
        "type": "function",
        "z": "9137a9b2.f5e7d8",
        "g": "96ca1e42.77651",
        "name": "",
        "func": "msg.data = {};\nmsg.data.sujet = \"db_e_f_queue\";\nmsg.data.user = true;\ntry{\n    msg.p_next = false;\n    if(msg.payload != null && msg.payload != 'null')\n        msg.p_next = msg.payload.length > 0 ? true : false;\n    return msg;\n}catch(err){\n    node.error(err);\n    msg.p_next = false;\n    return msg;\n}",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 2600,
        "y": 140,
        "wires": [
            [
                "cbd02ae1.f7e648"
            ]
        ]
    },
    {
        "id": "cbd02ae1.f7e648",
        "type": "switch",
        "z": "9137a9b2.f5e7d8",
        "g": "96ca1e42.77651",
        "name": "",
        "property": "p_next",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            },
            {
                "t": "false"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 2770,
        "y": 140,
        "wires": [
            [
                "3cc3a9a8.386a96"
            ],
            [
                "d5031f5.7a422e"
            ]
        ]
    },
    {
        "id": "3cc3a9a8.386a96",
        "type": "function",
        "z": "9137a9b2.f5e7d8",
        "g": "839e847e.e0aae8",
        "name": "",
        "func": "let msg_clone = {...msg}\nmsg_clone.count = {\n    inline : msg.payload[0].q_count,\n    inside : msg.payload[1].q_count,\n    ticket : msg.payload[2].q_count\n}\n// \nif(msg_clone.count.inside >= global.get('queue_in_max'))\n    msg_clone.payload = JSON.stringify({bracelet : msg_clone.old.payload.bracelet_mac, passe : false, ticket : msg_clone.count.ticket});\nelse if(msg_clone.count.inside < global.get('queue_in_max'))\n    msg_clone.payload = JSON.stringify({bracelet : msg_clone.old.payload.bracelet_mac, passe : true});\n// \nif(msg_clone.count.inside > global.get('queue_in_max'))\n    msg_clone.payload = null;\n// \nconst device_channel_id = msg.old.topic.substring(msg.old.topic.lastIndexOf('/') + 1);\nmsg_clone.topic = `bracelet/queue/response/send/${device_channel_id}`;\n// \nreturn msg_clone;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 2940,
        "y": 140,
        "wires": [
            [
                "aba526e9.7d2ad8"
            ]
        ]
    },
    {
        "id": "d5031f5.7a422e",
        "type": "debug",
        "z": "9137a9b2.f5e7d8",
        "name": "error finding",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 2950,
        "y": 220,
        "wires": []
    },
    {
        "id": "45c73ee9.63b5a",
        "type": "inject",
        "z": "9137a9b2.f5e7d8",
        "g": "2a66e0db.3d554",
        "name": "set env global variables",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": "0",
        "topic": "",
        "payload": "true",
        "payloadType": "bool",
        "x": 230,
        "y": 60,
        "wires": [
            [
                "7eb1aa6c.ce50a4"
            ]
        ]
    },
    {
        "id": "7eb1aa6c.ce50a4",
        "type": "function",
        "z": "9137a9b2.f5e7d8",
        "g": "2a66e0db.3d554",
        "name": "set values",
        "func": "global.set('queue_in_max',4);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 440,
        "y": 60,
        "wires": [
            [
                "a1808b36.4a8398"
            ]
        ]
    },
    {
        "id": "a1808b36.4a8398",
        "type": "debug",
        "z": "9137a9b2.f5e7d8",
        "g": "2a66e0db.3d554",
        "name": "",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 630,
        "y": 60,
        "wires": []
    },
    {
        "id": "aba526e9.7d2ad8",
        "type": "switch",
        "z": "9137a9b2.f5e7d8",
        "g": "839e847e.e0aae8",
        "name": "",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "nnull"
            },
            {
                "t": "null"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 3110,
        "y": 140,
        "wires": [
            [
                "d1e2b7f2.fb5218"
            ],
            [
                "83211f12.864ec"
            ]
        ]
    },
    {
        "id": "83211f12.864ec",
        "type": "debug",
        "z": "9137a9b2.f5e7d8",
        "name": "more bracelets in room than max nb allowed",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 3380,
        "y": 220,
        "wires": []
    },
    {
        "id": "d1e2b7f2.fb5218",
        "type": "mqtt out",
        "z": "9137a9b2.f5e7d8",
        "g": "839e847e.e0aae8",
        "name": "",
        "topic": "",
        "qos": "",
        "retain": "",
        "broker": "c9a66da.209299",
        "x": 3270,
        "y": 140,
        "wires": []
    },
    {
        "id": "9635978a.55f6d8",
        "type": "comment",
        "z": "9137a9b2.f5e7d8",
        "g": "98550463.c21328",
        "name": "error managment",
        "info": "adopt this model for all wanted error managment\n---\nfor now this wont work\n**solution** => add an object called .error with data {error:'notificaction_topic',msg:'error_msg'}",
        "x": 3880,
        "y": 260,
        "wires": []
    },
    {
        "id": "6bbad059.6fed",
        "type": "switch",
        "z": "9137a9b2.f5e7d8",
        "g": "98550463.c21328",
        "name": "",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "0",
                "vt": "num"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 3850,
        "y": 220,
        "wires": [
            [
                "6b2a8840.578b88",
                "3e89fd3.f69b502"
            ]
        ]
    },
    {
        "id": "d84a82b4.23df4",
        "type": "mqtt out",
        "z": "9137a9b2.f5e7d8",
        "g": "98550463.c21328",
        "name": "inform admin",
        "topic": "",
        "qos": "",
        "retain": "",
        "broker": "c9a66da.209299",
        "x": 4730,
        "y": 220,
        "wires": []
    },
    {
        "id": "6b2a8840.578b88",
        "type": "debug",
        "z": "9137a9b2.f5e7d8",
        "g": "98550463.c21328",
        "name": "error saving data",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 4050,
        "y": 220,
        "wires": []
    },
    {
        "id": "8ccfc47f.d25ee8",
        "type": "mysql",
        "z": "9137a9b2.f5e7d8",
        "g": "98550463.c21328",
        "mydb": "455cfbb2.9d9714",
        "name": "save notification",
        "x": 4320,
        "y": 160,
        "wires": [
            [
                "665a6f04.1846b",
                "2884029b.44fd1e"
            ]
        ]
    },
    {
        "id": "665a6f04.1846b",
        "type": "debug",
        "z": "9137a9b2.f5e7d8",
        "g": "98550463.c21328",
        "name": "notification save log",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 4550,
        "y": 160,
        "wires": []
    },
    {
        "id": "3e89fd3.f69b502",
        "type": "function",
        "z": "9137a9b2.f5e7d8",
        "g": "98550463.c21328",
        "name": "prepare notification query",
        "func": "// const sujet = \"db_e_s_histo\";\nconst sujet = msg.data.sujet;\nconst broker_id = 1;\nlet date = new Date(); \ndate = date.toISOString().slice(0, 19).replace('T', ' ');\nmsg.data.date = date;\n// \nmsg.payload = [sujet, date, broker_id, msg.data.user == false ? null : msg.old.payload.bracelet_mac];\nif(msg.data.user == false)\n    msg.topic = \"INSERT INTO `notification` (`idNotification`, `sujetNotification`, `dateNotification`, `idBroker`, `idPersonnel`) VALUES(NULL, ?, ?, ?, ?);\";\nelse\n    msg.topic = \"INSERT INTO `notification` (`idNotification`, `sujetNotification`, `dateNotification`, `idBroker`, `idPersonnel`) SELECT NULL, ?, ?, ?, `idPersonnel` FROM personnel WHERE macBracelet = ? LIMIT 1;\";\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 4070,
        "y": 160,
        "wires": [
            [
                "8ccfc47f.d25ee8",
                "511474f5.a0e38c"
            ]
        ]
    },
    {
        "id": "2884029b.44fd1e",
        "type": "function",
        "z": "9137a9b2.f5e7d8",
        "g": "98550463.c21328",
        "name": "data format",
        "func": "msg.topic = `admin/notif`;\nmsg.payload = JSON.stringify({code : msg.data.sujet, user : msg.old.payload.bracelet_mac, date : msg.data.date, broker : msg.broker});\n// \nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 4530,
        "y": 220,
        "wires": [
            [
                "d84a82b4.23df4"
            ]
        ]
    },
    {
        "id": "511474f5.a0e38c",
        "type": "debug",
        "z": "9137a9b2.f5e7d8",
        "g": "98550463.c21328",
        "name": "query log",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 4300,
        "y": 220,
        "wires": []
    },
    {
        "id": "791e5401.a31f0c",
        "type": "function",
        "z": "ca426e9f.74914",
        "g": "3f880a49.478716",
        "name": "",
        "func": "msg.payload = [msg.mac];\nmsg.topic = \"SELECT m.`contentMessage` AS msg, (SUM(rp.nbPoints) + p.pointsPersonnel) AS points FROM recordPoints AS rp, personnel AS p, `message` AS m WHERE rp.idPersonnel IN (SELECT `idPersonnel` FROM personnel WHERE macBracelet = ?) AND rp.idPersonnel = p.idPersonnel AND rp.idPersonnel = m.idPersonnel AND YEAR(rp.dateRecordPoints) = YEAR(CURRENT_DATE()) AND MONTH(rp.dateRecordPoints) = MONTH(CURRENT_DATE()) GROUP BY msg, m.`dateMessage` ORDER BY m.`dateMessage` DESC LIMIT 1\";\n// \nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 1340,
        "y": 340,
        "wires": [
            [
                "90b6e771.e8f048"
            ]
        ]
    },
    {
        "id": "90b6e771.e8f048",
        "type": "mysql",
        "z": "ca426e9f.74914",
        "g": "3f880a49.478716",
        "mydb": "455cfbb2.9d9714",
        "name": "",
        "x": 1520,
        "y": 340,
        "wires": [
            [
                "4e51a684.18e388"
            ]
        ]
    },
    {
        "id": "cdc23649.082158",
        "type": "function",
        "z": "ca426e9f.74914",
        "g": "72cb9daa.bab524",
        "name": "",
        "func": "let msg_clone = { ...msg };\n// \nmsg_clone.old = {\n    payload : msg.payload,\n    topic : msg.topic\n}\n// \nif(!msg_clone.payload.broker || msg_clone.payload.broker == null || msg_clone.payload.broker == 'null' || !msg_clone.payload.bracelet || msg_clone.payload.bracelet == null || msg_clone.payload.bracelet == 'null'){\n    msg_clone.payload = false;\n} else msg_clone.payload = true;\n// \nreturn msg_clone;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 1020,
        "y": 740,
        "wires": [
            [
                "5bde32ae.7b4f0c",
                "944441a7.34a7c"
            ]
        ]
    },
    {
        "id": "de51f706.6bbf68",
        "type": "change",
        "z": "ca426e9f.74914",
        "g": "72cb9daa.bab524",
        "name": "",
        "rules": [
            {
                "t": "change",
                "p": "payload",
                "pt": "msg",
                "from": "'",
                "fromt": "str",
                "to": "\"",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 600,
        "y": 740,
        "wires": [
            [
                "9971e316.2ae56"
            ]
        ]
    },
    {
        "id": "9971e316.2ae56",
        "type": "json",
        "z": "ca426e9f.74914",
        "g": "72cb9daa.bab524",
        "name": "format object",
        "property": "payload",
        "action": "",
        "pretty": false,
        "x": 830,
        "y": 740,
        "wires": [
            [
                "cdc23649.082158"
            ]
        ]
    },
    {
        "id": "944441a7.34a7c",
        "type": "debug",
        "z": "ca426e9f.74914",
        "name": "",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1190,
        "y": 800,
        "wires": []
    },
    {
        "id": "5bde32ae.7b4f0c",
        "type": "switch",
        "z": "ca426e9f.74914",
        "g": "72cb9daa.bab524",
        "name": "",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            },
            {
                "t": "false"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1190,
        "y": 740,
        "wires": [
            [
                "f2758db8.b21ac"
            ],
            [
                "c07e0620.07a788",
                "4130679c.e94608"
            ]
        ]
    },
    {
        "id": "c07e0620.07a788",
        "type": "debug",
        "z": "ca426e9f.74914",
        "name": "basic data not provided",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1430,
        "y": 800,
        "wires": []
    },
    {
        "id": "23dfa971.dbc096",
        "type": "comment",
        "z": "ca426e9f.74914",
        "name": "Add feedback",
        "info": "",
        "x": 1390,
        "y": 880,
        "wires": []
    },
    {
        "id": "bc2bc4bf.580848",
        "type": "function",
        "z": "ca426e9f.74914",
        "g": "c4263f1b.7a02d",
        "name": "",
        "func": "let ret_array = [];\n// Add historique\nret_array.push({ ...msg });\nret_array[0].payload = [`déconnecté`, msg.old.idPers];\nret_array[0].topic = \"INSERT INTO `historique` (`idHistorique`, `actionHistorique`, `dateHistorique`, `idPersonnel`) VALUES (NULL, ?, NULL, ?)\";\nret_array[0].err_code = \"db_e_s_histo\";\n// Update profile status\nret_array.push({ ...msg });\nret_array[1].payload = [msg.old.idPers];\nret_array[1].topic = \"UPDATE `personnel` SET `onlinePersonnel` = 0 WHERE `idPersonnel` = ?\";\nret_array[1].err_code = \"db_e_u_perso\";\n// Save record\nret_array[2] = { ...msg };\nif(!msg.old.payload.record || msg.old.payload.record == null || msg.old.payload.record == 'null')\n    ret_array[2].payload = null;\nelse{\n    // ret_array.push({ ...msg });\n    // \n    ret_array[2].payload = [];\n    ret_array[2].topic = \"INSERT INTO `record` (`idRecord`, `battementCoeur`, `temperature`, `oxygene`, `dateRecord`, `idBroker`, `idPersonnel`) VALUES \";\n    ret_array[2].err_code = \"db_e_s_recordPoints\";\n    // \n    for(let i = 0; i < msg.old.payload.record.length; i++){\n        const record = msg.old.payload.record[i];\n        //\n        ret_array[2].payload.push(record.data.bc, record.data.temp, record.data.oxy, record.date , msg.old.idBrok, msg.old.idPers)\n        ret_array[2].topic += \"(NULL, ?, ?, ?, ?, ?, ?)\"\n        // \n        if(i < msg.old.payload.record.length - 1)\n            ret_array[2].topic += \", \";\n        else ret_array[2].topic += \";\";\n    }\n}\n// Save convergance\nret_array[3] = { ...msg };\nif(!msg.old.payload.convergence || msg.old.payload.convergence == null || msg.old.payload.convergence == 'null')\n    ret_array[3].payload = null;\nelse{\n    ret_array[3].payload = \"conv\";\n}\n// \nreturn ret_array;",
        "outputs": 4,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 2080,
        "y": 700,
        "wires": [
            [
                "920c161c.5e5be8"
            ],
            [
                "920c161c.5e5be8"
            ],
            [
                "920c161c.5e5be8"
            ],
            [
                "2de50935.6ed236"
            ]
        ]
    },
    {
        "id": "920c161c.5e5be8",
        "type": "switch",
        "z": "ca426e9f.74914",
        "g": "c4263f1b.7a02d",
        "name": "",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "nnull"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 2250,
        "y": 680,
        "wires": [
            [
                "480e704.82b549"
            ]
        ]
    },
    {
        "id": "f2758db8.b21ac",
        "type": "function",
        "z": "ca426e9f.74914",
        "g": "3b7292ed.26d4ce",
        "name": "",
        "func": "msg.payload = [msg.old.payload.bracelet, msg.old.payload.broker];\nmsg.topic = \"SELECT p.idPersonnel, b.idBroker FROM `personnel` AS p, broker AS b WHERE p.macBracelet = ? AND b.macBroker = ?;\"\n// \nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 1380,
        "y": 720,
        "wires": [
            [
                "1ce40efa.1e66a1"
            ]
        ]
    },
    {
        "id": "1ce40efa.1e66a1",
        "type": "mysql",
        "z": "ca426e9f.74914",
        "g": "3b7292ed.26d4ce",
        "mydb": "455cfbb2.9d9714",
        "name": "",
        "x": 1560,
        "y": 720,
        "wires": [
            [
                "7534db37.d52994"
            ]
        ]
    },
    {
        "id": "7534db37.d52994",
        "type": "function",
        "z": "ca426e9f.74914",
        "g": "3b7292ed.26d4ce",
        "name": "",
        "func": "let msg_clone = { ...msg };\ntry{\n    if(msg.payload != null || msg.payload != 'null'){\n        msg_clone.payload = msg.payload.length == 1 ? true : false;\n        // \n        if(msg_clone.payload){\n            msg_clone.old.idPers = msg.payload[0].idPersonnel;\n            msg_clone.old.idBrok = msg.payload[0].idBroker;\n        }\n    }\n    return msg_clone;\n}catch(err){\n    node.error(err);\n    msg_clone.payload = false;\n    return msg_clone;\n}",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 1740,
        "y": 720,
        "wires": [
            [
                "1f0d3eee.9cb261"
            ]
        ]
    },
    {
        "id": "1f0d3eee.9cb261",
        "type": "switch",
        "z": "ca426e9f.74914",
        "g": "c4263f1b.7a02d",
        "name": "",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            },
            {
                "t": "false"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1910,
        "y": 720,
        "wires": [
            [
                "bc2bc4bf.580848"
            ],
            [
                "a8a63785.972848",
                "75f77cf0.0523d4"
            ]
        ]
    },
    {
        "id": "a8a63785.972848",
        "type": "debug",
        "z": "ca426e9f.74914",
        "name": "error, bracelet/broker not found",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 2150,
        "y": 760,
        "wires": []
    },
    {
        "id": "2de50935.6ed236",
        "type": "switch",
        "z": "ca426e9f.74914",
        "g": "c4263f1b.7a02d",
        "name": "",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "nnull"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 2250,
        "y": 720,
        "wires": [
            [
                "1b112e9a.5330c1"
            ]
        ]
    },
    {
        "id": "480e704.82b549",
        "type": "mysql",
        "z": "ca426e9f.74914",
        "mydb": "455cfbb2.9d9714",
        "name": "",
        "x": 2420,
        "y": 680,
        "wires": [
            [
                "a83b2939.85a4e8"
            ]
        ]
    },
    {
        "id": "de5c07ee.959ec8",
        "type": "function",
        "z": "ca426e9f.74914",
        "name": "",
        "func": "msg.data = {};\nmsg.data.sujet = \"db_e_s_convergence\";\nmsg.data.user = true;\ntry{\n    if(msg.payload != null && msg.payload != 'null')\n        msg.payload = msg.payload.affectedRows != 0 ? true : false;\n    return msg;\n}catch(err){\n    node.error(err);\n    msg.payload = false;\n    return msg;\n}",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 3460,
        "y": 720,
        "wires": [
            [
                "c3a0c633.34f638"
            ]
        ]
    },
    {
        "id": "c3a0c633.34f638",
        "type": "switch",
        "z": "ca426e9f.74914",
        "name": "",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "1",
                "vt": "num"
            },
            {
                "t": "eq",
                "v": "0",
                "vt": "num"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 3630,
        "y": 720,
        "wires": [
            [
                "c17fe5b9.44d568"
            ],
            [
                "ed24bb0e.8b8ef8"
            ]
        ]
    },
    {
        "id": "c17fe5b9.44d568",
        "type": "function",
        "z": "ca426e9f.74914",
        "name": "insert into recordpoints",
        "func": "const raison = `Ne pas maintenir la distance sociale`;\nconst data = msg.old.payload.convergence[0];\nlet date = new Date(); \ndate = date.toISOString().slice(0, 19).replace('T', ' ');\nconst points = data.distance >= 1 ? data.distance < 1.5 ? -5 : 0 : -15;\n// \nif(points != 0){\n    msg.payload = [raison, date, points, data.bracelet_1, msg.old.payload.broker, raison, date, points, data.bracelet_2, msg.old.payload.broker];\n    msg.topic = \"INSERT INTO `recordPoints` (`idRecordPoints`, `raisonRecordPoints`, `dateRecordPoints`, `nbPoints`, `idBroker`, `idPersonnel`) (SELECT NULL, ?, ?, ?, idBroker, idPersonnel FROM personnel AS p, broker AS b WHERE idPersonnel IN (SELECT idPersonnel FROM personnel WHERE macBracelet = ?) AND idBroker IN (SELECT idBroker FROM broker WHERE macBroker = ?)) UNION ALL (SELECT NULL, ?, ?, ?, idBroker, idPersonnel FROM personnel AS p, broker AS b WHERE idPersonnel IN (SELECT idPersonnel FROM personnel WHERE macBracelet = ?) AND idBroker IN (SELECT idBroker FROM broker WHERE macBroker = ?))\";\n}else msg.payload = false;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 3840,
        "y": 720,
        "wires": [
            [
                "23b2ca43.b81e56",
                "566d5448.2f13bc"
            ]
        ]
    },
    {
        "id": "23b2ca43.b81e56",
        "type": "switch",
        "z": "ca426e9f.74914",
        "name": "",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "neq",
                "v": "0",
                "vt": "num"
            },
            {
                "t": "false"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 4050,
        "y": 720,
        "wires": [
            [
                "a114e088.12674"
            ],
            [
                "12e89a9c.078165"
            ]
        ]
    },
    {
        "id": "a114e088.12674",
        "type": "mysql",
        "z": "ca426e9f.74914",
        "mydb": "455cfbb2.9d9714",
        "name": "",
        "x": 4220,
        "y": 720,
        "wires": [
            [
                "d4bb4eac.658ed",
                "636531c4.036f7"
            ]
        ]
    },
    {
        "id": "d4bb4eac.658ed",
        "type": "function",
        "z": "ca426e9f.74914",
        "name": "",
        "func": "msg.data = {};\nmsg.data.sujet = \"db_e_s_recordPoints\";\nmsg.data.user = true;\ntry{\n    if(msg.payload != null && msg.payload != 'null')\n        msg.payload = msg.payload.affectedRows != 0 ? true : false;\n    return msg;\n}catch(err){\n    node.error(err);\n    msg.payload = false;\n    return msg;\n}",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 4400,
        "y": 720,
        "wires": [
            [
                "12e89a9c.078165",
                "ed24bb0e.8b8ef8"
            ]
        ]
    },
    {
        "id": "566d5448.2f13bc",
        "type": "debug",
        "z": "ca426e9f.74914",
        "name": "",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 4070,
        "y": 780,
        "wires": []
    },
    {
        "id": "636531c4.036f7",
        "type": "debug",
        "z": "ca426e9f.74914",
        "name": "",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 4410,
        "y": 780,
        "wires": []
    },
    {
        "id": "c9cdb5f9.c1c808",
        "type": "function",
        "z": "ca426e9f.74914",
        "name": "prepare insert query",
        "func": "const data = msg.old.payload.convergence[0];\n// \nmsg.payload = [data.date, data.distance, msg.old.payload.broker, data.bracelet_1, data.bracelet_2];\nmsg.topic = \"INSERT INTO convergence (`idConvergence`, `dateConvergence`, `distanceConvergence`, `idBroker`, `idPersonnel`, `idPersonnel_2`) SELECT NULL, ?, ?, br.idBroker, pr1.idPersonnel, pr2.idPersonnel FROM broker AS br, personnel AS pr1, personnel AS pr2 WHERE br.idBroker IN (SELECT idBroker FROM broker WHERE macBroker = ?) AND pr1.idPersonnel IN (SELECT idPersonnel FROM personnel WHERE macBracelet = ?) AND pr2.idPersonnel IN (SELECT idPersonnel FROM personnel WHERE macBracelet = ?)\";\n// \nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 3060,
        "y": 720,
        "wires": [
            [
                "9e6b9069.e816d"
            ]
        ]
    },
    {
        "id": "9e6b9069.e816d",
        "type": "mysql",
        "z": "ca426e9f.74914",
        "mydb": "455cfbb2.9d9714",
        "name": "",
        "x": 3280,
        "y": 720,
        "wires": [
            [
                "de5c07ee.959ec8"
            ]
        ]
    },
    {
        "id": "1b112e9a.5330c1",
        "type": "function",
        "z": "ca426e9f.74914",
        "name": "search for duplicates",
        "func": "const data = msg.old.payload.convergence[0];\nconst delay_interval = 5;\n// \nmsg.payload = [data.bracelet_1, data.bracelet_2, data.bracelet_1, data.bracelet_2, data.date, delay_interval, delay_interval, data.distance];\nmsg.topic = \"SELECT COUNT(*) as `exist` FROM `convergence` WHERE `idPersonnel` IN (SELECT `idPersonnel` FROM personnel WHERE macBracelet = ? OR `idPersonnel` IN (SELECT `idPersonnel` FROM personnel WHERE macBracelet = ?)) AND `idPersonnel_2` IN (SELECT `idPersonnel` FROM personnel WHERE macBracelet = ? OR `idPersonnel_2` IN (SELECT `idPersonnel` FROM personnel WHERE macBracelet = ?)) AND TIMESTAMPDIFF(SECOND, `dateConvergence`, ?) BETWEEN -? AND ? AND CAST(`distanceConvergence` AS CHAR) = ?\"\n// \nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 2460,
        "y": 720,
        "wires": [
            [
                "c757aa84.9355e8"
            ]
        ]
    },
    {
        "id": "c757aa84.9355e8",
        "type": "mysql",
        "z": "ca426e9f.74914",
        "mydb": "455cfbb2.9d9714",
        "name": "",
        "x": 2680,
        "y": 720,
        "wires": [
            [
                "98322a89.514ed8"
            ]
        ]
    },
    {
        "id": "98322a89.514ed8",
        "type": "switch",
        "z": "ca426e9f.74914",
        "name": "",
        "property": "payload[0].exist",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "0",
                "vt": "num"
            },
            {
                "t": "gt",
                "v": "0",
                "vt": "num"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 2850,
        "y": 720,
        "wires": [
            [
                "c9cdb5f9.c1c808"
            ],
            [
                "12e89a9c.078165"
            ]
        ]
    },
    {
        "id": "12e89a9c.078165",
        "type": "function",
        "z": "ca426e9f.74914",
        "name": "",
        "func": "if(msg.old.payload.convergence.length > 1){\n    msg.old.payload.convergence.shift();\n    msg.payload = true;\n}else msg.payload = false;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 2420,
        "y": 760,
        "wires": [
            [
                "1a1b0d22.69d5a3"
            ]
        ]
    },
    {
        "id": "1a1b0d22.69d5a3",
        "type": "switch",
        "z": "ca426e9f.74914",
        "name": "",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            },
            {
                "t": "false"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 2590,
        "y": 760,
        "wires": [
            [
                "1b112e9a.5330c1"
            ],
            [
                "4a7def2e.2f48a"
            ]
        ]
    },
    {
        "id": "2eb6ce4d.5c0442",
        "type": "debug",
        "z": "ca426e9f.74914",
        "name": "",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 2050,
        "y": 380,
        "wires": []
    },
    {
        "id": "a83b2939.85a4e8",
        "type": "function",
        "z": "ca426e9f.74914",
        "name": "insertion valdiation",
        "func": "msg.data = {};\nmsg.data.sujet = msg.err_code;\n// \ntry{\n    if(msg.payload != null && msg.payload != 'null')\n        msg.payload = msg.payload.affectedRows != 0 ? true : false;\n    return msg;\n}catch(err){\n    node.error(err);\n    msg.payload = false;\n    return msg;\n}",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 2630,
        "y": 680,
        "wires": [
            [
                "ed24bb0e.8b8ef8"
            ]
        ]
    },
    {
        "id": "f6cdeae0.89d008",
        "type": "mqtt out",
        "z": "ca426e9f.74914",
        "g": "cdac6aae.82e518",
        "name": "bracelet feedback",
        "topic": "",
        "qos": "",
        "retain": "",
        "broker": "c9a66da.209299",
        "x": 4750,
        "y": 860,
        "wires": []
    },
    {
        "id": "2a0c88ea.cabc58",
        "type": "function",
        "z": "ca426e9f.74914",
        "g": "cdac6aae.82e518",
        "name": "gen topic",
        "func": "let msg_clone = { ...msg };\nconst device_channel_id = msg.old.topic.substring(msg.old.topic.lastIndexOf('/') + 1);\nmsg_clone.topic = `bracelet/auth/response/disconnect/${device_channel_id}`;\n//\nreturn msg_clone;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 4540,
        "y": 860,
        "wires": [
            [
                "f6cdeae0.89d008"
            ]
        ]
    },
    {
        "id": "4a7def2e.2f48a",
        "type": "function",
        "z": "ca426e9f.74914",
        "g": "212eb9bd.d3a8e6",
        "name": "",
        "func": "msg.payload = [msg.old.idPers, msg.old.idPers];\nmsg.topic = \"SELECT IFNULL(SUM(rp.nbPoints), 0) AS r_points, NULL AS points FROM recordPoints AS rp WHERE rp.idPersonnel = ? AND YEAR(rp.dateRecordPoints) = YEAR(CURRENT_DATE()) AND MONTH(rp.dateRecordPoints) = MONTH(CURRENT_DATE()) AND DAY(rp.dateRecordPoints) = DAY(CURRENT_DATE()) UNION ALL SELECT IFNULL(SUM(rp2.nbPoints), 0), IFNULL((SUM(rp2.nbPoints) + p.pointsPersonnel), p.pointsPersonnel) FROM recordPoints AS rp2, personnel AS p WHERE rp2.idPersonnel = ? AND rp2.idPersonnel = p.idPersonnel AND YEAR(rp2.dateRecordPoints) = YEAR(CURRENT_DATE()) AND MONTH(rp2.dateRecordPoints) = MONTH(CURRENT_DATE())\";\n// \nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 2780,
        "y": 800,
        "wires": [
            [
                "2e80569e.b3828a"
            ]
        ]
    },
    {
        "id": "2e80569e.b3828a",
        "type": "mysql",
        "z": "ca426e9f.74914",
        "g": "212eb9bd.d3a8e6",
        "mydb": "455cfbb2.9d9714",
        "name": "",
        "x": 2960,
        "y": 800,
        "wires": [
            [
                "4eb35255.4effcc"
            ]
        ]
    },
    {
        "id": "4eb35255.4effcc",
        "type": "function",
        "z": "ca426e9f.74914",
        "g": "212eb9bd.d3a8e6",
        "name": "",
        "func": "let msg_clone = { ...msg };\nmsg_clone.data.sujet = \"db_e_f_recordPoints\";\n// \ntry{\n    if(msg.payload != null && msg.payload != 'null')\n        msg_clone.p_next = msg.payload.length == 2 ? true : false;\n    return msg_clone;\n}catch(err){\n    node.error(err);\n    msg_clone.p_next = false;\n    return msg_clone;\n}",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 3140,
        "y": 800,
        "wires": [
            [
                "3ce2f6ba.66a1fa",
                "4eaa41e9.b3825"
            ]
        ]
    },
    {
        "id": "3ce2f6ba.66a1fa",
        "type": "switch",
        "z": "ca426e9f.74914",
        "name": "",
        "property": "p_next",
        "propertyType": "msg",
        "rules": [
            {
                "t": "false"
            },
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 3290,
        "y": 800,
        "wires": [
            [
                "ed24bb0e.8b8ef8"
            ],
            [
                "5066ea45.1e8824"
            ]
        ]
    },
    {
        "id": "5066ea45.1e8824",
        "type": "function",
        "z": "ca426e9f.74914",
        "name": "",
        "func": "let msg_clone = { ...msg };\nlet messages = {positive : ['good_1','good_2','good_3'], negative : ['bad_1','bad_2']};\n// \nconst random = (max) => {\n    return Math.floor(Math.random() * (max + 1));\n}\n// \nlet ret_data = { points: msg.payload[1].points, msg : messages.positive[random(messages.positive.length - 1)]};\n// msg.payload[0].r_points => points removed today\n// msg.payload[1].r_points => points removed this month\n// msg.payload[0].points => null\n// msg.payload[1].points => total points for this month with reductions\nif(msg.payload[0].r_points < 0)\n    ret_data.msg = messages.negative[random(messages.negative.length - 1)];\n// \nmsg_clone.old.response = ret_data;\nreturn msg_clone;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 3460,
        "y": 800,
        "wires": [
            [
                "1f34a8e8.41cfe7"
            ]
        ]
    },
    {
        "id": "1f34a8e8.41cfe7",
        "type": "function",
        "z": "ca426e9f.74914",
        "g": "bbaad6bd.889a48",
        "name": "",
        "func": "msg.payload = [msg.old.idPers];\nmsg.topic = \"SELECT Y.*, COUNT(p2.idPersonnel) AS nbPerso FROM ( SELECT x.*, ( @rownum := @rownum + 1 ) AS rank FROM ( SELECT DISTINCT p.idPersonnel, SUM(rp.nbPoints), IFNULL((SUM(rp.nbPoints) + p.pointsPersonnel), p.pointsPersonnel) AS score FROM recordPoints AS rp, personnel AS p, (SELECT @rownum :=0)r WHERE YEAR(rp.dateRecordPoints) = YEAR(CURRENT_DATE()) AND MONTH(rp.dateRecordPoints) = MONTH(CURRENT_DATE()) AND rp.idPersonnel = p.idPersonnel GROUP BY p.idPersonnel ORDER BY score DESC ) AS x ) AS Y, personnel AS p2 WHERE Y.idPersonnel = ? GROUP BY Y.rank\"\n// \nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 3640,
        "y": 820,
        "wires": [
            [
                "18d786af.f2efb9",
                "fb3bef09.dcc09"
            ]
        ]
    },
    {
        "id": "18d786af.f2efb9",
        "type": "mysql",
        "z": "ca426e9f.74914",
        "g": "bbaad6bd.889a48",
        "mydb": "455cfbb2.9d9714",
        "name": "",
        "x": 3820,
        "y": 820,
        "wires": [
            [
                "bce55376.50184"
            ]
        ]
    },
    {
        "id": "bce55376.50184",
        "type": "function",
        "z": "ca426e9f.74914",
        "g": "bbaad6bd.889a48",
        "name": "",
        "func": "let msg_clone = { ...msg };\nmsg_clone.data.sujet = \"db_e_f_rank\";\n// \ntry{\n    if(msg.payload != null && msg.payload != 'null')\n        msg_clone.p_next = msg.payload.length == 1 ? true : false;\n    return msg_clone;\n}catch(err){\n    node.error(err);\n    msg_clone.p_next = false;\n    return msg_clone;\n}",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 4000,
        "y": 820,
        "wires": [
            [
                "3ec0cb36.a5d8e4",
                "fb3bef09.dcc09"
            ]
        ]
    },
    {
        "id": "3ec0cb36.a5d8e4",
        "type": "switch",
        "z": "ca426e9f.74914",
        "name": "",
        "property": "p_next",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            },
            {
                "t": "false"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 4170,
        "y": 820,
        "wires": [
            [
                "4110e587.2968cc"
            ],
            [
                "c18f5ae8.7bce48"
            ]
        ]
    },
    {
        "id": "4110e587.2968cc",
        "type": "function",
        "z": "ca426e9f.74914",
        "g": "cdac6aae.82e518",
        "name": "",
        "func": "let msg_clone = { ...msg };\n//\nmsg_clone.old.response.rank = `${msg.payload[0].rank}/${msg.payload[0].nbPerso}`;\nmsg_clone.ret = {status : 'success', data : msg_clone.old.response}\nmsg_clone.payload = msg_clone.ret;\n// \nreturn msg_clone;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 4360,
        "y": 860,
        "wires": [
            [
                "2a0c88ea.cabc58"
            ]
        ]
    },
    {
        "id": "fb3bef09.dcc09",
        "type": "debug",
        "z": "ca426e9f.74914",
        "name": "",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 4170,
        "y": 880,
        "wires": []
    },
    {
        "id": "4eaa41e9.b3825",
        "type": "debug",
        "z": "ca426e9f.74914",
        "name": "",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 3310,
        "y": 860,
        "wires": []
    },
    {
        "id": "c18f5ae8.7bce48",
        "type": "function",
        "z": "ca426e9f.74914",
        "name": "i",
        "func": "msg.payload = false;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 1910,
        "y": 420,
        "wires": [
            [
                "ed24bb0e.8b8ef8"
            ]
        ]
    },
    {
        "id": "4130679c.e94608",
        "type": "function",
        "z": "ca426e9f.74914",
        "name": "",
        "func": "let msg_clone = { ...msg };\nmsg_clone.data.sujet = 'e_format_data';\n//\nmsg_clone.ret = {status : 'fail', data : msg_clone.data.sujet}\nmsg_clone.payload = false;\n// \nreturn msg_clone;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 1380,
        "y": 840,
        "wires": [
            [
                "ec405a87.094068",
                "ed24bb0e.8b8ef8"
            ]
        ]
    },
    {
        "id": "ee0aaadd.7da518",
        "type": "mqtt out",
        "z": "ca426e9f.74914",
        "name": "bracelet feedback",
        "topic": "",
        "qos": "",
        "retain": "",
        "broker": "c9a66da.209299",
        "x": 1770,
        "y": 840,
        "wires": []
    },
    {
        "id": "ec405a87.094068",
        "type": "function",
        "z": "ca426e9f.74914",
        "name": "gen topic",
        "func": "let msg_clone = { ...msg };\nconst device_channel_id = msg.old.topic.substring(msg.old.topic.lastIndexOf('/') + 1);\nmsg_clone.topic = `bracelet/auth/response/disconnect/${device_channel_id}`;\nmsg_clone.payload = msg_clone.ret;\n//\nreturn msg_clone;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 1560,
        "y": 840,
        "wires": [
            [
                "ee0aaadd.7da518"
            ]
        ]
    },
    {
        "id": "75f77cf0.0523d4",
        "type": "function",
        "z": "ca426e9f.74914",
        "name": "",
        "func": "let msg_clone = { ...msg };\nmsg_clone.data.sujet = 'e_BB_nf';\n//\nmsg_clone.ret = {status : 'fail', data : msg_clone.data.sujet}\nmsg_clone.payload = false;\n// \nreturn msg_clone;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 2080,
        "y": 800,
        "wires": [
            [
                "ec405a87.094068",
                "ed24bb0e.8b8ef8"
            ]
        ]
    },
    {
        "id": "ddaa329.cdb85d",
        "type": "function",
        "z": "ae64b298.b7071",
        "g": "2428ed.453b6714",
        "name": "",
        "func": "msg.payload = [msg.old.payload.mac];\nmsg.topic = \"SELECT idPersonnel FROM `personnel` WHERE macBracelet = ?\"\n// \nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 1740,
        "y": 160,
        "wires": [
            [
                "f1c28713.ed06f8"
            ]
        ]
    },
    {
        "id": "f1c28713.ed06f8",
        "type": "mysql",
        "z": "ae64b298.b7071",
        "g": "2428ed.453b6714",
        "mydb": "455cfbb2.9d9714",
        "name": "",
        "x": 1920,
        "y": 160,
        "wires": [
            [
                "40a4657a.37da7c"
            ]
        ]
    },
    {
        "id": "40a4657a.37da7c",
        "type": "function",
        "z": "ae64b298.b7071",
        "g": "2428ed.453b6714",
        "name": "",
        "func": "let msg_clone = { ...msg };\ntry{\n    if(msg.payload != null || msg.payload != 'null'){\n        msg_clone.payload = msg.payload.length == 1 ? true : false;\n        // \n        if(msg_clone.payload)\n            msg_clone.old.idPers = msg.payload[0].idPersonnel;\n    }\n    return msg_clone;\n}catch(err){\n    node.error(err);\n    msg_clone.payload = false;\n    return msg_clone;\n}",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 2100,
        "y": 160,
        "wires": [
            [
                "1b3dc267.28380e"
            ]
        ]
    },
    {
        "id": "1b3dc267.28380e",
        "type": "switch",
        "z": "ae64b298.b7071",
        "name": "",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            },
            {
                "t": "false"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 2270,
        "y": 160,
        "wires": [
            [
                "cff7ce90.7384d"
            ],
            [
                "c0c83bc9.e05648"
            ]
        ]
    },
    {
        "id": "c0c83bc9.e05648",
        "type": "function",
        "z": "ae64b298.b7071",
        "name": "",
        "func": "let msg_clone = { ...msg };\nmsg_clone.data.sujet = 'e_BB_nf';\n//\nmsg_clone.ret = {status : 'fail', data : msg_clone.data.sujet}\nmsg_clone.payload = false;\n// \nreturn msg_clone;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 2440,
        "y": 180,
        "wires": [
            [
                "21abda46.d794f6"
            ]
        ]
    },
    {
        "id": "22277ff4.83afa",
        "type": "mqtt in",
        "z": "9137a9b2.f5e7d8",
        "name": "",
        "topic": "bracelet/queue_room/send/#",
        "qos": "2",
        "datatype": "auto",
        "broker": "c9a66da.209299",
        "x": 200,
        "y": 540,
        "wires": [
            [
                "6dc8e276.d96a9c"
            ]
        ]
    },
    {
        "id": "74cc2f2c.d168a",
        "type": "comment",
        "z": "9137a9b2.f5e7d8",
        "name": "get a ticket",
        "info": "",
        "x": 140,
        "y": 240,
        "wires": []
    },
    {
        "id": "6dc8e276.d96a9c",
        "type": "change",
        "z": "9137a9b2.f5e7d8",
        "name": "",
        "rules": [
            {
                "t": "change",
                "p": "payload",
                "pt": "msg",
                "from": "'",
                "fromt": "str",
                "to": "\"",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 480,
        "y": 540,
        "wires": [
            [
                "69af6ee1.edaed"
            ]
        ],
        "info": "\"{'bracelet_mac' : '', 'broker_mac' : '', 'parent_mac' : ''}\""
    },
    {
        "id": "69af6ee1.edaed",
        "type": "json",
        "z": "9137a9b2.f5e7d8",
        "name": "format object",
        "property": "payload",
        "action": "",
        "pretty": false,
        "x": 710,
        "y": 540,
        "wires": [
            [
                "1306fa2f.afe226"
            ]
        ]
    },
    {
        "id": "1306fa2f.afe226",
        "type": "function",
        "z": "9137a9b2.f5e7d8",
        "name": "",
        "func": "let msg_clone = msg;\nmsg_clone.old = {\n    payload : msg.payload,\n    topic : msg.topic\n};\n// \nmsg_clone.payload = [msg_clone.old.payload.parent_mac, msg_clone.old.payload.bracelet_mac, msg_clone.old.payload.parent_mac];\nmsg_clone.topic = \"SELECT `idQueue`, `stateQueue` AS state, qq.inSide FROM `queue`, (SELECT IFNULL(COUNT(`idQueue`), 0) AS inSide FROM queue WHERE stateQueue = 0 AND `idBroker` IN (SELECT `idBroker` FROM broker WHERE `macBroker` = ?)) AS qq WHERE queue.`idPersonnel` IN (SELECT `idPersonnel` FROM `personnel` WHERE macBracelet = ?) AND queue.`idBroker` IN (SELECT `idBroker` FROM broker WHERE `macBroker` = ?) ORDER BY queue.`date_TQueue` DESC LIMIT 1\";\n// \nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 900,
        "y": 540,
        "wires": [
            [
                "3e804a89.1545d6",
                "67f849f9.104db8"
            ]
        ]
    },
    {
        "id": "3e804a89.1545d6",
        "type": "mysql",
        "z": "9137a9b2.f5e7d8",
        "mydb": "455cfbb2.9d9714",
        "name": "",
        "x": 1080,
        "y": 540,
        "wires": [
            [
                "f9d03878.b65748",
                "3fa52225.07636e"
            ]
        ]
    },
    {
        "id": "3fa52225.07636e",
        "type": "function",
        "z": "9137a9b2.f5e7d8",
        "name": "",
        "func": "let date = new Date(); \ndate = date.toISOString().slice(0, 19).replace('T', ' ');\n// \nmsg.old.date = date;\ntry{\n    let status = null;\n    if(msg.payload != null && msg.payload != 'null'){\n        if(msg.payload.length > 0){\n            msg.old.idQueue = msg.payload[0].idQueue;\n            // \n            if(msg.payload[0].state == -1){\n                if(msg.payload[0].inSide < global.get('queue_in_max'))\n                    status = 1;\n                else status = -1;\n            }else{\n                if(msg.payload[0].state == 0)\n                    status = 0;\n                else status = -1;\n            }\n        }else status = -1;\n    }\n    msg.p_next = status;\n    return msg;\n}catch(err){\n    node.error(err);\n    msg.p_next = null;\n    return msg;\n}",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 1260,
        "y": 540,
        "wires": [
            [
                "be0d277e.929168"
            ]
        ]
    },
    {
        "id": "be0d277e.929168",
        "type": "switch",
        "z": "9137a9b2.f5e7d8",
        "name": "",
        "property": "p_next",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "1",
                "vt": "num"
            },
            {
                "t": "eq",
                "v": "0",
                "vt": "num"
            },
            {
                "t": "eq",
                "v": "-1",
                "vt": "str"
            },
            {
                "t": "null"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 4,
        "x": 1430,
        "y": 540,
        "wires": [
            [
                "46ef3f67.b132a"
            ],
            [
                "789623ce.03a49c"
            ],
            [
                "18bf5017.2be26"
            ],
            [
                "538bdf1a.65689"
            ]
        ]
    },
    {
        "id": "538bdf1a.65689",
        "type": "debug",
        "z": "9137a9b2.f5e7d8",
        "name": "system error",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1610,
        "y": 720,
        "wires": []
    },
    {
        "id": "86fc3465.937358",
        "type": "function",
        "z": "9137a9b2.f5e7d8",
        "name": "prepare queries",
        "func": "let msg_clone = [{ ...msg }, { ...msg }];\nmsg_clone[0].payload = [msg.old.date, msg.old.idQueue];\nmsg_clone[0].topic = \"UPDATE `queue` SET `stateQueue` = 0, `date_DQueue` = ? WHERE `idQueue` = ?\";\n// \nmsg_clone[1].payload = [msg.old.date, msg.old.idQueue, msg.old.payload.bracelet_mac, msg.old.payload.broker_mac];\nmsg_clone[1].topic = \"INSERT INTO `queueRoom` (`idQueueRoom`, `dateQueueRoom`, `idPersonnel`, `idBroker`, `idQueue`) SELECT NULL, ?, `idPersonnel`, `idBroker`, ? FROM `personnel`, `broker` WHERE `idPersonnel` IN (SELECT `idPersonnel` FROM `personnel` WHERE macBracelet = ?) AND `idBroker` IN (SELECT `idBroker` FROM broker WHERE `macBroker` = ?)\";\n// \nreturn msg_clone;",
        "outputs": 2,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 2400,
        "y": 320,
        "wires": [
            [
                "4027732b.61be1c"
            ],
            [
                "28a843dd.be278c"
            ]
        ]
    },
    {
        "id": "4027732b.61be1c",
        "type": "mysql",
        "z": "9137a9b2.f5e7d8",
        "mydb": "455cfbb2.9d9714",
        "name": "update queue status",
        "x": 2640,
        "y": 300,
        "wires": [
            [
                "a270009c.b5bf1"
            ]
        ]
    },
    {
        "id": "28a843dd.be278c",
        "type": "mysql",
        "z": "9137a9b2.f5e7d8",
        "mydb": "455cfbb2.9d9714",
        "name": "add room queue log",
        "x": 2640,
        "y": 340,
        "wires": [
            [
                "3ba69cfe.b8e0d4"
            ]
        ]
    },
    {
        "id": "e4073719.2c6008",
        "type": "switch",
        "z": "9137a9b2.f5e7d8",
        "name": "",
        "property": "p_next",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            },
            {
                "t": "false"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 3030,
        "y": 300,
        "wires": [
            [
                "a15bcadc.485518"
            ],
            [
                "a15bcadc.485518"
            ]
        ]
    },
    {
        "id": "a15bcadc.485518",
        "type": "debug",
        "z": "9137a9b2.f5e7d8",
        "name": "",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 3210,
        "y": 300,
        "wires": []
    },
    {
        "id": "3ba69cfe.b8e0d4",
        "type": "function",
        "z": "9137a9b2.f5e7d8",
        "name": "",
        "func": "msg.data = {};\nmsg.data.sujet = \"db_e_s_queueRoom\";\nmsg.data.user = true;\ntry{\n    msg.p_next = false;\n    if(msg.payload != null && msg.payload != 'null')\n        msg.p_next = msg.payload.affectedRows != 0 ? true : false;\n    // \n    msg.queueRoomId = msg.payload.insertId;\n    return msg;\n}catch(err){\n    node.error(err);\n    msg.p_next = false;\n    return msg;\n}",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 2860,
        "y": 340,
        "wires": [
            [
                "d5e8469e.54d348"
            ]
        ]
    },
    {
        "id": "d5e8469e.54d348",
        "type": "switch",
        "z": "9137a9b2.f5e7d8",
        "name": "",
        "property": "p_next",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            },
            {
                "t": "false"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 3030,
        "y": 340,
        "wires": [
            [
                "39b427b0.bb6188"
            ],
            [
                "39b427b0.bb6188"
            ]
        ]
    },
    {
        "id": "39b427b0.bb6188",
        "type": "debug",
        "z": "9137a9b2.f5e7d8",
        "name": "",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 3210,
        "y": 340,
        "wires": []
    },
    {
        "id": "a270009c.b5bf1",
        "type": "function",
        "z": "9137a9b2.f5e7d8",
        "name": "",
        "func": "msg.data = {};\nmsg.data.sujet = \"db_e_u_queue\";\nmsg.data.user = true;\ntry{\n    msg.p_next = false;\n    if(msg.payload != null && msg.payload != 'null')\n        msg.p_next = msg.payload.affectedRows != 0 ? true : false;\n    return msg;\n}catch(err){\n    node.error(err);\n    msg.p_next = false;\n    return msg;\n}",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 2860,
        "y": 300,
        "wires": [
            [
                "e4073719.2c6008"
            ]
        ]
    },
    {
        "id": "67f849f9.104db8",
        "type": "debug",
        "z": "9137a9b2.f5e7d8",
        "name": "",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1070,
        "y": 600,
        "wires": []
    },
    {
        "id": "f9d03878.b65748",
        "type": "debug",
        "z": "9137a9b2.f5e7d8",
        "name": "",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 1270,
        "y": 600,
        "wires": []
    },
    {
        "id": "789623ce.03a49c",
        "type": "function",
        "z": "9137a9b2.f5e7d8",
        "g": "b12f86f0.a40768",
        "name": "prepare query",
        "func": "const interval = 5; // in sec\nconst max_stay_time = 120; //in sec\n// \nmsg.payload = [msg.old.payload.bracelet_mac, msg.old.date, interval, msg.old.payload.broker_mac, msg.old.payload.bracelet_mac, msg.old.date, max_stay_time];\nmsg.topic = \"SELECT COUNT(qr1.`idPersonnel`) AS `status`, NULL AS occurrences FROM queueRoom AS qr1 WHERE qr1.`idPersonnel` IN (SELECT `idPersonnel` FROM `personnel` WHERE macBracelet = ?) AND TIMESTAMPDIFF(SECOND, qr1.dateQueueRoom, ?) <= ? AND qr1.`idBroker` NOT IN (SELECT `idBroker` FROM broker WHERE `macBroker` = ?) UNION ALL SELECT NULL, COUNT(occ.occurrences) AS occurrences FROM ( SELECT COUNT(`idPersonnel`) AS occurrences FROM queueRoom WHERE `idPersonnel` IN (SELECT `idPersonnel` FROM `personnel` WHERE macBracelet = ?) AND TIMESTAMPDIFF(SECOND, dateQueueRoom, ?) <= ? GROUP BY `idBroker` ) AS occ\";\n// \nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 1640,
        "y": 540,
        "wires": [
            [
                "7223d3e7.58edfc"
            ]
        ]
    },
    {
        "id": "7223d3e7.58edfc",
        "type": "mysql",
        "z": "9137a9b2.f5e7d8",
        "g": "b12f86f0.a40768",
        "mydb": "455cfbb2.9d9714",
        "name": "",
        "x": 1840,
        "y": 540,
        "wires": [
            [
                "fe7ec1e9.97ea4"
            ]
        ]
    },
    {
        "id": "fe7ec1e9.97ea4",
        "type": "function",
        "z": "9137a9b2.f5e7d8",
        "g": "b12f86f0.a40768",
        "name": "",
        "func": "msg.data = {};\nmsg.data.sujet = \"db_e_f_queueRoom\";\nmsg.data.user = true;\ntry{\n    msg.p_next = null;\n    if(msg.payload != null && msg.payload != 'null'){\n        if(msg.payload.length == 2){\n            if(msg.payload[0].status > 0)\n                msg.p_next = true;\n            else\n                msg.p_next = msg.payload[1].occurrences <= 1 ? true : false; //if = 0/1 => FIRST TIME | = 2 => already went in at some point\n        }\n    }\n    return msg;\n}catch(err){\n    node.error(err);\n    msg.p_next = null;\n    return msg;\n}",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 2020,
        "y": 540,
        "wires": [
            [
                "65c6b7d3.d200d8",
                "994eff1f.660b4"
            ]
        ]
    },
    {
        "id": "65c6b7d3.d200d8",
        "type": "switch",
        "z": "9137a9b2.f5e7d8",
        "name": "",
        "property": "p_next",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            },
            {
                "t": "false"
            },
            {
                "t": "null"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 3,
        "x": 2210,
        "y": 540,
        "wires": [
            [
                "e5729c9b.c7486"
            ],
            [
                "81278cb0.be11d",
                "e5729c9b.c7486"
            ],
            [
                "445405c0.94287c"
            ]
        ]
    },
    {
        "id": "445405c0.94287c",
        "type": "debug",
        "z": "9137a9b2.f5e7d8",
        "name": "system error",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 2390,
        "y": 660,
        "wires": []
    },
    {
        "id": "e5729c9b.c7486",
        "type": "function",
        "z": "9137a9b2.f5e7d8",
        "name": "prepare query",
        "func": "msg.payload = [msg.old.date, msg.old.idQueue, msg.old.payload.bracelet_mac, msg.old.payload.broker_mac];\nmsg.topic = \"INSERT INTO `queueRoom` (`idQueueRoom`, `dateQueueRoom`, `idPersonnel`, `idBroker`, `idQueue`) SELECT NULL, ?, `idPersonnel`, `idBroker`, ? FROM `personnel`, `broker` WHERE `idPersonnel` IN (SELECT `idPersonnel` FROM `personnel` WHERE macBracelet = ?) AND `idBroker` IN (SELECT `idBroker` FROM broker WHERE `macBroker` = ?)\";\n//\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 2400,
        "y": 520,
        "wires": [
            [
                "befc1901.d43ea8"
            ]
        ]
    },
    {
        "id": "befc1901.d43ea8",
        "type": "mysql",
        "z": "9137a9b2.f5e7d8",
        "mydb": "455cfbb2.9d9714",
        "name": "add room queue log",
        "x": 2640,
        "y": 520,
        "wires": [
            [
                "d9457705.be7968"
            ]
        ]
    },
    {
        "id": "d9457705.be7968",
        "type": "function",
        "z": "9137a9b2.f5e7d8",
        "name": "",
        "func": "msg.data = {};\nmsg.data.sujet = \"db_e_s_queueRoom\";\nmsg.data.user = true;\ntry{\n    msg.p_next = false;\n    if(msg.payload != null && msg.payload != 'null')\n        msg.p_next = msg.payload.affectedRows != 0 ? true : false;\n    // \n    msg.queueRoomId = msg.payload.insertId;\n    return msg;\n}catch(err){\n    node.error(err);\n    msg.p_next = false;\n    return msg;\n}",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 2860,
        "y": 520,
        "wires": [
            [
                "3479caa8.4cb4c6"
            ]
        ]
    },
    {
        "id": "3479caa8.4cb4c6",
        "type": "switch",
        "z": "9137a9b2.f5e7d8",
        "name": "",
        "property": "p_next",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            },
            {
                "t": "false"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 3030,
        "y": 520,
        "wires": [
            [
                "ed41b601.0db8a8"
            ],
            [
                "ed41b601.0db8a8"
            ]
        ]
    },
    {
        "id": "ed41b601.0db8a8",
        "type": "debug",
        "z": "9137a9b2.f5e7d8",
        "name": "",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 3210,
        "y": 520,
        "wires": []
    },
    {
        "id": "81278cb0.be11d",
        "type": "function",
        "z": "9137a9b2.f5e7d8",
        "name": "prepare query",
        "func": "msg.payload = [msg.old.date, msg.old.idQueue];\nmsg.topic = \"UPDATE `queue` SET `stateQueue` = 1, `date_FQueue` = ? WHERE `idQueue` = ?\";\n// \nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 2400,
        "y": 560,
        "wires": [
            [
                "472b7457.53c66c"
            ]
        ]
    },
    {
        "id": "472b7457.53c66c",
        "type": "mysql",
        "z": "9137a9b2.f5e7d8",
        "mydb": "455cfbb2.9d9714",
        "name": "update queue status",
        "x": 2640,
        "y": 560,
        "wires": [
            [
                "e750edd4.f9ac8"
            ]
        ]
    },
    {
        "id": "7d2fed76.c9bd14",
        "type": "switch",
        "z": "9137a9b2.f5e7d8",
        "name": "",
        "property": "p_next",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            },
            {
                "t": "false"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 3030,
        "y": 560,
        "wires": [
            [
                "700f7894.a7e9d8"
            ],
            [
                "700f7894.a7e9d8"
            ]
        ]
    },
    {
        "id": "700f7894.a7e9d8",
        "type": "debug",
        "z": "9137a9b2.f5e7d8",
        "name": "",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 3210,
        "y": 600,
        "wires": []
    },
    {
        "id": "e750edd4.f9ac8",
        "type": "function",
        "z": "9137a9b2.f5e7d8",
        "name": "",
        "func": "msg.data = {};\nmsg.data.sujet = \"db_e_u_queue\";\nmsg.data.user = true;\ntry{\n    msg.p_next = false;\n    if(msg.payload != null && msg.payload != 'null')\n        msg.p_next = msg.payload.affectedRows != 0 ? true : false;\n    return msg;\n}catch(err){\n    node.error(err);\n    msg.p_next = false;\n    return msg;\n}",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 2860,
        "y": 560,
        "wires": [
            [
                "7d2fed76.c9bd14"
            ]
        ]
    },
    {
        "id": "f161b4cc.8b7278",
        "type": "comment",
        "z": "9137a9b2.f5e7d8",
        "name": "5sec interval is here",
        "info": "",
        "x": 1630,
        "y": 480,
        "wires": []
    },
    {
        "id": "994eff1f.660b4",
        "type": "debug",
        "z": "9137a9b2.f5e7d8",
        "name": "msg",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 2210,
        "y": 600,
        "wires": []
    },
    {
        "id": "46ef3f67.b132a",
        "type": "function",
        "z": "9137a9b2.f5e7d8",
        "g": "7cfe8395.77f95c",
        "name": "prepare query",
        "func": "msg.payload = [msg.old.payload.broker_mac, msg.old.payload.broker_mac, msg.old.payload.bracelet_mac, msg.old.payload.broker_mac, msg.old.payload.bracelet_mac];\nmsg.topic = \"SELECT * FROM (SELECT COUNT(idQueue) AS inSide FROM queue WHERE stateQueue = 0 AND idBroker IN (SELECT `idBroker` FROM broker WHERE macBroker = ?)) AS t1, (SELECT COUNT(`idQueue`) AS nb_beforeMe FROM queue WHERE `idQueue` < (SELECT `idQueue` FROM queue WHERE idBroker IN (SELECT `idBroker` FROM broker WHERE macBroker = ?) AND idPersonnel IN (SELECT `idPersonnel` FROM personnel WHERE macBracelet = ?) ORDER BY `date_TQueue` DESC LIMIT 1) AND `stateQueue` = -1) AS t2, (SELECT (COUNT(`idQueue`) + 1) AS nb_ticket FROM queue WHERE `idQueue` < (SELECT `idQueue` FROM queue WHERE `stateQueue` = -1 AND idBroker IN (SELECT `idBroker` FROM broker WHERE macBroker = ?) AND idPersonnel IN (SELECT `idPersonnel` FROM personnel WHERE macBracelet = ?) ORDER BY `date_TQueue` DESC LIMIT 1)) AS t3\"\n// \nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 1640,
        "y": 380,
        "wires": [
            [
                "7e01799a.f5cac8"
            ]
        ]
    },
    {
        "id": "7e01799a.f5cac8",
        "type": "mysql",
        "z": "9137a9b2.f5e7d8",
        "g": "7cfe8395.77f95c",
        "mydb": "455cfbb2.9d9714",
        "name": "",
        "x": 1840,
        "y": 380,
        "wires": [
            [
                "709f3ddd.b01134"
            ]
        ]
    },
    {
        "id": "709f3ddd.b01134",
        "type": "function",
        "z": "9137a9b2.f5e7d8",
        "g": "7cfe8395.77f95c",
        "name": "",
        "func": "msg.data = {};\nmsg.data.sujet = \"db_e_f_queueData\";\nmsg.data.user = true;\n// \nconst _TRESHOLD = Math.ceil(global.get('queue_in_max') / 2);\n// \ntry{\n    msg.p_next = null;\n    if(msg.payload != null && msg.payload != 'null'){\n        if(msg.payload.length == 1){\n            msg.old.ticket = msg.payload[0].nb_ticket;\n            if(msg.payload[0].nb_beforeMe == 0)\n                msg.p_next = true;\n            else{\n                if(msg.payload[0].nb_beforeMe < (global.get('queue_in_max') - msg.payload[0].inSide))\n                    msg.p_next = true;\n                else{\n                    msg.p_next = msg.payload[0].nb_beforeMe > _TRESHOLD ? '_clear' : false;\n                }\n            }\n        }\n    }\n    return msg;\n}catch(err){\n    node.error(err);\n    msg.p_next = null;\n    return msg;\n}",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 2020,
        "y": 380,
        "wires": [
            [
                "2d34141.7110cec"
            ]
        ]
    },
    {
        "id": "2d34141.7110cec",
        "type": "switch",
        "z": "9137a9b2.f5e7d8",
        "name": "",
        "property": "p_next",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            },
            {
                "t": "false"
            },
            {
                "t": "eq",
                "v": "_clear",
                "vt": "str"
            },
            {
                "t": "null"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 4,
        "x": 2210,
        "y": 380,
        "wires": [
            [
                "86fc3465.937358"
            ],
            [
                "8c0bb2a7.cc811"
            ],
            [
                "8c0bb2a7.cc811"
            ],
            [
                "1484d5d0.91710a"
            ]
        ]
    },
    {
        "id": "8c0bb2a7.cc811",
        "type": "function",
        "z": "9137a9b2.f5e7d8",
        "name": "not allowed to go through",
        "func": "const device_channel_id = msg.old.topic.substring(msg.old.topic.lastIndexOf('/') + 1);\nmsg.topic = `bracelet/queue_room/response/send/${device_channel_id}`;\nmsg.payload = msg_clone.payload = JSON.stringify({bracelet : msg.old.payload.bracelet_mac, passe : false, ticket : msg.old.ticket ? msg.old.ticket : null});\n// \nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 2430,
        "y": 380,
        "wires": [
            [
                "57eb9a7e.f50e44"
            ]
        ]
    },
    {
        "id": "1484d5d0.91710a",
        "type": "debug",
        "z": "9137a9b2.f5e7d8",
        "name": "system error",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 2390,
        "y": 440,
        "wires": []
    },
    {
        "id": "57eb9a7e.f50e44",
        "type": "mqtt out",
        "z": "9137a9b2.f5e7d8",
        "name": "",
        "topic": "",
        "qos": "",
        "retain": "",
        "broker": "c9a66da.209299",
        "x": 2650,
        "y": 380,
        "wires": []
    },
    {
        "id": "8c8e31cc.c2bb6",
        "type": "comment",
        "z": "9137a9b2.f5e7d8",
        "name": "first time in",
        "info": "",
        "x": 1600,
        "y": 320,
        "wires": []
    },
    {
        "id": "ab04584c.eca1d8",
        "type": "comment",
        "z": "9137a9b2.f5e7d8",
        "name": "already in",
        "info": "",
        "x": 1600,
        "y": 440,
        "wires": []
    },
    {
        "id": "1b74ef14.df4d31",
        "type": "comment",
        "z": "9137a9b2.f5e7d8",
        "name": "take a ticket first",
        "info": "",
        "x": 1620,
        "y": 620,
        "wires": []
    },
    {
        "id": "18bf5017.2be26",
        "type": "function",
        "z": "9137a9b2.f5e7d8",
        "name": "",
        "func": "const device_channel_id = msg.old.topic.substring(msg.old.topic.lastIndexOf('/') + 1);\nmsg.topic = `bracelet/queue_room/response/send/${device_channel_id}`;\nmsg.payload = msg_clone.payload = JSON.stringify({bracelet : msg.old.payload.bracelet_mac, passe : false, ticket : null});\n// \nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 1600,
        "y": 660,
        "wires": [
            [
                "23b80aa0.d43326"
            ]
        ]
    },
    {
        "id": "23b80aa0.d43326",
        "type": "mqtt out",
        "z": "9137a9b2.f5e7d8",
        "name": "",
        "topic": "",
        "qos": "",
        "retain": "",
        "broker": "c9a66da.209299",
        "x": 1770,
        "y": 660,
        "wires": []
    },
    {
        "id": "b00ab503.7c8b18",
        "type": "comment",
        "z": "9137a9b2.f5e7d8",
        "name": "user in room still",
        "info": "",
        "x": 2400,
        "y": 480,
        "wires": []
    },
    {
        "id": "8ca57d82.4a9c6",
        "type": "comment",
        "z": "9137a9b2.f5e7d8",
        "name": "user out of room",
        "info": "",
        "x": 2400,
        "y": 600,
        "wires": []
    },
    {
        "id": "baadbab5.575398",
        "type": "function",
        "z": "9137a9b2.f5e7d8",
        "name": "ping the broker",
        "func": "\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 3220,
        "y": 560,
        "wires": [
            [
                "8e118ede.44523"
            ]
        ],
        "info": "ping the broker to inform the next persone in line to get through"
    },
    {
        "id": "8e118ede.44523",
        "type": "mqtt out",
        "z": "9137a9b2.f5e7d8",
        "name": "",
        "topic": "",
        "qos": "",
        "retain": "",
        "broker": "c9a66da.209299",
        "x": 3410,
        "y": 560,
        "wires": []
    }
]